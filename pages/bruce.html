<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruce - Fede Life</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    <link rel="stylesheet" href="app.css">
</head>

<body>
       <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-title">Fede Life</span>
            </div>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="finanzas.html" >Finanzas</a></li>
                <li><a href="tareas.html">Tareas</a></li>
                <li><a href="bruce.html" class="active">Bruce</a></li>
            </ul>
        </div>
    </nav>
    <header>
        <h1>Preguntale a Bruce</h1>

        <!-- Estado de autenticaci√≥n -->
        <div id="auth-status" class="auth-status">
            <div id="userInfo" class="user-info" style="display: none;">
                <span>Bienvenido, <span id="userName"></span></span>
                <button id="logoutBtn" class="logout-btn">Cerrar Sesi√≥n</button>
            </div>
            <div id="authButton" class="auth-button" style="display: none;">
                <button onclick="window.location.href='login.html'" class="login-btn">Iniciar Sesi√≥n</button>
            </div>
            <div id="autoAuthButton" class="auto-auth-button" style="display: none;">
                <button onclick="tryAutoLogin()" class="auto-login-btn">Login Autom√°tico</button>
            </div>
        </div>
    </header>
    <main>
        <section class="chat-container">
            <div id="chat-history" class="chat-history">
                <div class="message ai-message">
                    <div class="message-content">
                        <strong>Bruce:</strong> ¬°Hola! Soy Bruce, tu asistente IA. Puedes enviarme texto o im√°genes y te
                        responder√© con informaci√≥n √∫til. ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-area">
                    <textarea id="user-input" placeholder="Escribe tu mensaje aqu√≠..." rows="3"></textarea>
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                    <div class="image-preview" id="image-preview" style="display: none;">
                        <img id="preview-img" src="" alt="Vista previa">
                        <button id="remove-image" class="remove-btn">&times;</button>
                    </div>
                </div>
                <div class="controls">
                    <button id="attach-image" class="attach-btn" title="Adjuntar imagen">üìé</button>
                    <button id="send-message" class="send-btn">Enviar</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Botones para abrir modales laterales -->
    <button id="open-info" class="side-toggle left">‚ÑπÔ∏è</button>
    <button id="open-notes" class="side-toggle right">üìù</button>

    <!-- Modal lateral izquierdo: informaci√≥n del cultivo -->
    <div id="cultivo-info" class="side-modal left">
        <div class="side-header">
            <span>Informaci√≥n del Cultivo</span>
            <button class="close-btn" data-target="cultivo-info">&times;</button>
        </div>
        <div id="cultivo-info-content" class="side-content">
            <p>Selecciona un cultivo para ver la informaci√≥n.</p>
        </div>
    </div>

    <!-- Modal lateral derecho: notas del cultivo -->
    <div id="cultivo-notes" class="side-modal right">
        <div class="side-header">
            <span>Notas del Cultivo</span>
            <button class="close-btn" data-target="cultivo-notes">&times;</button>
        </div>
        <div class="side-content">
            <textarea id="notes-area" placeholder="Escribe tus notas aqu√≠..."></textarea>
            <button id="save-notes" class="save-notes-btn">Guardar</button>
        </div>
    </div>

    <footer>
        <p>&copy; Desde 1992 Fede Life. Todos los derechos reservados, dec√≠a</p>
    </footer>

    <script src="auth.js"></script>
    <script src="../funciones/cannabis_chat.js"></script>
    <script>
        class BruceAI {
            constructor() {
                this.chatHistory = document.getElementById('chat-history');
                this.userInput = document.getElementById('user-input');
                this.imageInput = document.getElementById('image-input');
                this.imagePreview = document.getElementById('image-preview');
                this.previewImg = document.getElementById('preview-img');
                this.sendButton = document.getElementById('send-message');
                this.attachButton = document.getElementById('attach-image');
                this.removeImageButton = document.getElementById('remove-image');

                this.infoPanel = document.getElementById('cultivo-info');
                this.notesPanel = document.getElementById('cultivo-notes');
                this.openInfoBtn = document.getElementById('open-info');
                this.openNotesBtn = document.getElementById('open-notes');
                this.notesArea = document.getElementById('notes-area');
                this.saveNotesBtn = document.getElementById('save-notes');
                this.infoContent = document.getElementById('cultivo-info-content');

                this.currentImage = null;
                this.currentCultivo = null;
                this.cultivos = {};

                // Inicializar chat de cannabis medicinal
                this.cannabisChat = window.cannabisChat || null;
                if (this.cannabisChat) {
                    console.log('‚úÖ Chat de cannabis medicinal cargado exitosamente');
                } else {
                    console.warn('‚ö†Ô∏è Chat de cannabis medicinal no encontrado, se inicializar√° cuando est√© disponible');
                }

                // Esperar a que la autenticaci√≥n est√© lista antes de inicializar
                this.waitForAuth().then(() => {
                    this.initializeEventListeners();
                    this.loadCultivos().then(() => {
                        this.initializeCultivoSelector();
                        this.updateCultivoDropdown();
                        this.showWelcomeMessage();
                        this.updateInfoPanel();
                    });
                });
            }


            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.attachButton.addEventListener('click', () => {
                    this.imageInput.click();
                });

                this.imageInput.addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                this.removeImageButton.addEventListener('click', () => {
                    this.removeImage();
                });

                this.openInfoBtn.addEventListener('click', () => this.togglePanel(this.infoPanel, true));
                this.openNotesBtn.addEventListener('click', () => this.togglePanel(this.notesPanel, true));
                this.infoPanel
                    .querySelector('.close-btn')
                    .addEventListener('click', () => this.togglePanel(this.infoPanel, false));
                this.notesPanel
                    .querySelector('.close-btn')
                    .addEventListener('click', () => this.togglePanel(this.notesPanel, false));
                this.saveNotesBtn.addEventListener('click', () => this.saveNotes());
            }

            // Gesti√≥n de cultivos con API
            async loadCultivos() {
                try {
                    const response = await fetch('/api/cultivos', {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.cultivos = {};
                        result.data.forEach(cultivo => {
                            this.cultivos[cultivo.id] = cultivo;
                        });
                        return this.cultivos;
                    } else {
                        console.error('Error cargando cultivos:', response.status);
                        return {};
                    }
                } catch (error) {
                    console.error('Error cargando cultivos:', error);
                    return {};
                }
            }

            getAuthToken() {
                // Obtener token de autenticaci√≥n del sistema de auth.js
                // Primero buscar en dev_auth_token (para desarrollo)
                let token = localStorage.getItem('dev_auth_token');

                // Si no est√°, buscar en auth_data
                if (!token) {
                    const authData = localStorage.getItem('auth_data');
                    if (authData) {
                        try {
                            const parsed = JSON.parse(authData);
                            token = parsed.token;
                        } catch (error) {
                            console.error('Error parseando auth_data:', error);
                        }
                    }
                }

                // Si a√∫n no hay token, buscar en authToken (compatibilidad)
                if (!token) {
                    token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                }

                return token || '';
            }

            getApiBaseUrl() {
                // Usar la misma l√≥gica que auth.js
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return 'http://localhost:3000/api';
                }
                return `${window.location.protocol}//${window.location.host}/api`;
            }

            async waitForAuth() {
                return new Promise((resolve) => {
                    // Verificar si ya hay un token disponible
                    if (this.getAuthToken()) {
                        resolve();
                        return;
                    }

                    // Si no hay token, esperar a que se complete la autenticaci√≥n autom√°tica
                    const checkAuth = () => {
                        if (this.getAuthToken()) {
                            resolve();
                        } else {
                            // Esperar un poco y verificar nuevamente
                            setTimeout(checkAuth, 500);
                        }
                    };

                    // Timeout despu√©s de 10 segundos para evitar esperar indefinidamente
                    setTimeout(() => {
                        console.warn('Timeout esperando autenticaci√≥n, continuando sin token');
                        resolve();
                    }, 10000);

                    checkAuth();
                });
            }

            initializeCultivoSelector() {
                const selectorContainer = document.createElement('div');
                selectorContainer.className = 'cultivo-selector';
                selectorContainer.innerHTML = `
                    <div class="cultivo-controls">
                        <select id="cultivo-select" class="cultivo-dropdown">
                            <option value="">Seleccionar cultivo...</option>
                        </select>
                        <button id="new-cultivo-btn" class="new-cultivo-btn">+ Nuevo Cultivo</button>
                        <button id="edit-cultivo-btn" class="edit-cultivo-btn" style="display: none;">‚úèÔ∏è Editar</button>
                        <button id="delete-cultivo-btn" class="delete-cultivo-btn" style="display: none;">üóëÔ∏è</button>
                    </div>
                `;

                this.chatHistory.parentNode.insertBefore(selectorContainer, this.chatHistory);

                this.cultivoSelect = document.getElementById('cultivo-select');
                this.newCultivoBtn = document.getElementById('new-cultivo-btn');
                this.editCultivoBtn = document.getElementById('edit-cultivo-btn');
                this.deleteCultivoBtn = document.getElementById('delete-cultivo-btn');

                this.cultivoSelect.addEventListener('change', (e) => this.selectCultivo(e.target.value));
                this.newCultivoBtn.addEventListener('click', () => this.createNewCultivo());
                this.editCultivoBtn.addEventListener('click', () => this.editCultivo());
                this.deleteCultivoBtn.addEventListener('click', () => this.deleteCultivo());

                this.updateCultivoDropdown();
            }

            updateCultivoDropdown() {
                const select = this.cultivoSelect;
                select.innerHTML = '<option value="">Seleccionar cultivo...</option>';

                Object.keys(this.cultivos).forEach(id => {
                    const cultivo = this.cultivos[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${cultivo.nombre} (${cultivo.variedad})`;
                    select.appendChild(option);
                });
            }

            async selectCultivo(cultivoId) {
                if (cultivoId) {
                    // Si no tenemos el cultivo en memoria, cargarlo desde la API
                    if (!this.cultivos[cultivoId]) {
                        try {
                            const response = await fetch(`/api/cultivos/${cultivoId}`, {
                                headers: {
                                    'Authorization': `Bearer ${this.getAuthToken()}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                const result = await response.json();
                                this.cultivos[cultivoId] = result.data;
                            } else {
                                console.error('Error cargando cultivo espec√≠fico:', response.status);
                                return;
                            }
                        } catch (error) {
                            console.error('Error cargando cultivo espec√≠fico:', error);
                            return;
                        }
                    }

                    this.currentCultivo = this.cultivos[cultivoId];
                    this.editCultivoBtn.style.display = 'inline-block';
                    this.deleteCultivoBtn.style.display = 'inline-block';

                    // Actualizar contexto del chat de cannabis
                    if (this.cannabisChat) {
                        this.cannabisChat.setCurrentCultivo(this.currentCultivo);
                        await this.loadCultivoNotes(); // Cargar notas para el contexto
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCurrentCultivo(this.currentCultivo);
                        await this.loadCultivoNotes();
                    }

                    this.loadCultivoChat();
                    this.updateInfoPanel();
                } else {
                    this.currentCultivo = null;
                    this.editCultivoBtn.style.display = 'none';
                    this.deleteCultivoBtn.style.display = 'none';

                    // Limpiar contexto del chat
                    if (this.cannabisChat) {
                        this.cannabisChat.setCurrentCultivo(null);
                        this.cannabisChat.setCultivoNotes([]);
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCurrentCultivo(null);
                        this.cannabisChat.setCultivoNotes([]);
                    }

                    this.showWelcomeMessage();
                    this.updateInfoPanel();
                }
            }

            async createNewCultivo() {
                const cultivoData = await this.promptCultivoData();
                if (cultivoData) {
                    try {
                        const response = await fetch('/api/cultivos', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[cultivo.id] = cultivo;
                            this.updateCultivoDropdown();
                            this.cultivoSelect.value = cultivo.id;
                            this.selectCultivo(cultivo.id);
                            this.addMessage('‚úÖ Cultivo creado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error creando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error creando cultivo:', error);
                        this.addMessage('‚ùå Error interno creando cultivo', 'ai');
                    }
                }
            }

            async editCultivo() {
                if (!this.currentCultivo) return;

                const cultivoData = await this.promptCultivoData(this.currentCultivo);
                if (cultivoData) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[this.currentCultivo.id] = cultivo;
                            this.currentCultivo = cultivo;
                            this.updateCultivoDropdown();
                            this.loadCultivoChat();
                            this.updateInfoPanel();
                            this.addMessage('‚úÖ Cultivo actualizado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error actualizando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error actualizando cultivo:', error);
                        this.addMessage('‚ùå Error interno actualizando cultivo', 'ai');
                    }
                }
            }

            async deleteCultivo() {
                if (!this.currentCultivo) return;

                if (confirm(`¬øEst√°s seguro de eliminar el cultivo "${this.currentCultivo.nombre}"?`)) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}?archive=true`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            delete this.cultivos[this.currentCultivo.id];
                            this.updateCultivoDropdown();
                            this.currentCultivo = null;
                            this.editCultivoBtn.style.display = 'none';
                            this.deleteCultivoBtn.style.display = 'none';
                            this.showWelcomeMessage();
                            this.updateInfoPanel();
                            this.addMessage('‚úÖ Cultivo archivado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error eliminando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error eliminando cultivo:', error);
                        this.addMessage('‚ùå Error interno eliminando cultivo', 'ai');
                    }
                }
            }

            async promptCultivoData(existingData = {}) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'cultivo-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>${existingData.id ? 'Editar' : 'Nuevo'} Cultivo de Cannabis Medicinal</h3>
                            <form id="cultivo-form">
                                <div class="form-group">
                                    <label>Nombre del cultivo:</label>
                                    <input type="text" id="nombre" value="${existingData.nombre || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Variedad/Cepa:</label>
                                    <input type="text" id="variedad" value="${existingData.variedad || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Medio de cultivo:</label>
                                    <select id="medio" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="fibra_coco" ${existingData.medio === 'fibra_coco' ? 'selected' : ''}>Fibra de coco</option>
                                        <option value="fibra_coco_perlita" ${existingData.medio === 'fibra_coco_perlita' ? 'selected' : ''}>Fibra de coco + perlita</option>
                                        <option value="light_mix" ${existingData.medio === 'light_mix' ? 'selected' : ''}>Light mix</option>
                                        <option value="hidro" ${existingData.medio === 'hidro' ? 'selected' : ''}>Hidro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Espacio de cultivo (m¬≤):</label>
                                    <input type="number" id="espacio" value="${existingData.espacio || ''}" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label>Tama√±o de macetas (L):</label>
                                    <input type="number" id="macetas" value="${existingData.macetas || ''}" step="1" placeholder="ej: 11, 20, 50..." required>
                                </div>
                                <div class="form-group">
                                    <label>Potencia lum√≠nica (W):</label>
                                    <input type="number" id="potencia" value="${existingData.potencia || ''}" placeholder="ej: 240, 600, 1000..." required>
                                </div>
                                <div class="form-group">
                                    <label>N√∫mero de plantas:</label>
                                    <input type="number" id="plantas" value="${existingData.plantas || ''}" min="1" placeholder="ej: 1, 4, 9..." required>
                                </div>
                                <div class="form-group">
                                    <label>Notas adicionales:</label>
                                    <textarea id="notas" rows="3" placeholder="Detalles espec√≠ficos, objetivos, observaciones...">${existingData.notas || ''}</textarea>
                                </div>
                                <div class="form-buttons">
                                    <button type="submit">${existingData.id ? 'Actualizar' : 'Crear'} Cultivo</button>
                                    <button type="button" onclick="this.closest('.cultivo-modal').remove()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    document.getElementById('cultivo-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const cultivoData = {
                            nombre: formData.get('nombre') || document.getElementById('nombre').value,
                            variedad: formData.get('variedad') || document.getElementById('variedad').value,
                            metodo: 'indoor', // Siempre indoor
                            medio: formData.get('medio') || document.getElementById('medio').value,
                            espacio: formData.get('espacio') || document.getElementById('espacio').value,
                            macetas: formData.get('macetas') || document.getElementById('macetas').value,
                            iluminacion: 'led', // Siempre LED
                            potencia: formData.get('potencia') || document.getElementById('potencia').value,
                            ventilacion: 'sistema_cerrado_co2', // Siempre sistema cerrado con CO2
                            plantas: formData.get('plantas') || document.getElementById('plantas').value,
                            notas: formData.get('notas') || document.getElementById('notas').value
                        };
                        modal.remove();
                        resolve(cultivoData);
                    });
                });
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentImage = e.target.result;
                        this.previewImg.src = this.currentImage;
                        this.imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            removeImage() {
                this.currentImage = null;
                this.previewImg.src = '';
                this.imagePreview.style.display = 'none';
                this.imageInput.value = '';
            }

            async sendMessage() {
                const message = this.userInput.value.trim();
                if (!message && !this.currentImage) return;

                if (!this.currentCultivo) {
                    this.addMessage('Por favor selecciona o crea un cultivo antes de hacer consultas.', 'ai');
                    return;
                }

                // Mostrar mensaje del usuario
                this.addMessage(message, 'user', this.currentImage);

                // Limpiar input
                this.userInput.value = '';
                const imageToProcess = this.currentImage;
                this.removeImage();

                // Mostrar indicador de typing
                this.showTypingIndicator();

                try {
                    // Procesar con IA especializada
                    const response = await this.processWithCannabiAI(message, imageToProcess);
                    this.removeTypingIndicator();
                    this.addMessage(response, 'ai');

                    // Guardar mensajes en la API
                    await this.saveChatMessage('user', message, imageToProcess);
                    await this.saveChatMessage('ai', response);
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addMessage('Lo siento, hubo un error procesando tu consulta. Por favor intenta de nuevo.', 'ai');
                    console.error('Error:', error);
                }
            }

            async saveChatMessage(type, content, image = null) {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type,
                            content,
                            image
                        })
                    });

                    if (!response.ok) {
                        console.error('Error guardando mensaje en chat:', response.status);
                    }
                } catch (error) {
                    console.error('Error guardando mensaje en chat:', error);
                }
            }

            async processWithCannabiAI(text, image) {
                try {
                    // Verificar si el chat de cannabis est√° cargado
                    if (!this.cannabisChat) {
                        console.warn('‚ö†Ô∏è Chat de cannabis no disponible, intentando inicializar...');
                        this.cannabisChat = window.cannabisChat || null;
                        if (!this.cannabisChat) {
                            return 'El sistema de IA especializado no est√° disponible. Verifica que el archivo cannabis_chat.js se haya cargado correctamente.';
                        }
                    }

                    // Usar el nuevo chat de cannabis medicinal con OpenAI
                    if (!this.cannabisChat.isReady()) {
                        return 'Lo siento, el sistema de IA no est√° configurado correctamente. Verifica tu API key de OpenAI.';
                    }

                    let messageToSend = text;

                    // Si hay imagen, agregar descripci√≥n
                    if (image) {
                        const imageDescription = 'He enviado una imagen del cultivo para an√°lisis.';
                        messageToSend = text ?
                            `${text}\n\n[Imagen adjunta: ${imageDescription}]` :
                            imageDescription;

                        // Para im√°genes, usar el m√©todo espec√≠fico de an√°lisis
                        const imageResult = await this.cannabisChat.analyzeCultivoImage(image, text);
                        if (imageResult.success) {
                            return imageResult.message;
                        } else {
                            return 'Error procesando la imagen. Por favor, intenta nuevamente.';
                        }
                    }

                    // Procesar consulta de texto con el chat de cannabis
                    const result = await this.cannabisChat.processQuery(messageToSend);

                    if (result.success) {
                        return result.message;
                    } else {
                        console.error('Error en chat de cannabis:', result.error);
                        return 'Lo siento, tuve un problema procesando tu consulta. Por favor, verifica tu conexi√≥n e intenta nuevamente.';
                    }

                } catch (error) {
                    console.error('Error en processWithCannabiAI:', error);
                    return 'Lo siento, hubo un error interno. Por favor, intenta nuevamente en unos momentos.';
                }
            }

            buildCultivoContext(cultivo) {
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                return `
Cultivo: ${cultivo.nombre}
Variedad: ${cultivo.variedad}
M√©todo: Indoor
Medio: ${medioDisplay[cultivo.medio] || cultivo.medio}
Espacio: ${cultivo.espacio}m¬≤
Macetas: ${cultivo.macetas}L
Plantas: ${cultivo.plantas}
Iluminaci√≥n: LED (${cultivo.potencia}W)
Ventilaci√≥n: Sistema cerrado con CO2
Fecha de inicio: ${new Date(cultivo.fechaCreacion).toLocaleDateString()}
Notas: ${cultivo.notas || 'Sin notas adicionales'}
                `.trim();
            }

            processCannabiText(text, context) {
                const lowerText = text.toLowerCase();

                // Respuestas espec√≠ficas sobre cultivo de cannabis medicinal
                if (lowerText.includes('germina') || lowerText.includes('semilla')) {
                    return `Para tu cultivo ${this.currentCultivo.nombre} (${this.currentCultivo.variedad}), te recomiendo:

**Germinaci√≥n de semillas:**
- M√©todo del papel h√∫medo: 24-72 horas en lugar oscuro a 22-25¬∞C
- Trasplante cuando la rad√≠cula mida 1-2cm
- Para ${this.currentCultivo.tipo}: ${this.getVarietySpecificTips()}
- Humedad: 70-80% durante germinaci√≥n

¬øNecesitas detalles espec√≠ficos sobre alg√∫n paso?`;
                }

                if (lowerText.includes('vegetativo') || lowerText.includes('crecimiento')) {
                    return `**Fase vegetativa para ${this.currentCultivo.variedad}:**

**Condiciones ambientales:**
- Temperatura: 20-26¬∞C
- Humedad: 40-60%
- Fotoper√≠odo: 18/6 horas (luz/oscuridad)
- pH ${this.currentCultivo.medio}: ${this.getpHRange()}

**Nutrici√≥n:**
- NPK alto en Nitr√≥geno (ej: 20-10-10)
- Riego: cuando los primeros 2cm de sustrato est√©n secos
- EC: 0.8-1.2 para ${this.currentCultivo.medio}

**Para tu objetivo de ${this.currentCultivo.objetivo}:** ${this.getTherapeuticTips()}`;
                }

                if (lowerText.includes('floracion') || lowerText.includes('cogollos')) {
                    return `**Floraci√≥n de ${this.currentCultivo.variedad}:**

**Cambios necesarios:**
- Fotoper√≠odo: 12/12 horas ${this.currentCultivo.tipo === 'autoflower' ? '(No necesario para autoflorecientes)' : ''}
- Temperatura: 18-24¬∞C
- Humedad: 30-45% (prevenir moho)

**Nutrici√≥n:**
- NPK alto en F√≥sforo y Potasio (ej: 10-30-20)
- Cal-Mag suplementario
- Flush final: 1-2 semanas antes de cosecha

**Se√±ales de madurez:** Tricomas lechosos al 70-80% para efectos terap√©uticos`;
                }

                if (lowerText.includes('problema') || lowerText.includes('enfermedad') || lowerText.includes('plaga')) {
                    return `**Diagn√≥stico para ${this.currentCultivo.nombre}:**

**Problemas comunes en ${this.currentCultivo.metodo}:**
- **Nutritivos:** Deficiencias de N, P, K, Cal-Mag
- **Ambientales:** Temperatura, humedad, ventilaci√≥n
- **Plagas:** Ara√±a roja, trips, pulgones, mosca blanca
- **Hongos:** O√≠dio, botrytis, fusarium

**Describe los s√≠ntomas espec√≠ficos** (color hojas, manchas, insectos visibles) y te dar√© un diagn√≥stico preciso con tratamiento org√°nico adecuado para cannabis medicinal.

¬øPuedes enviar una foto del problema?`;
                }

                if (lowerText.includes('cosecha') || lowerText.includes('secar') || lowerText.includes('curado')) {
                    return `**Cosecha y post-cosecha para ${this.currentCultivo.variedad}:**

**Momento √≥ptimo:**
- Tricomas: 70% lechosos, 20% √°mbar, 10% transparentes
- Para ${this.currentCultivo.objetivo}: ${this.getHarvestTiming()}

**Proceso:**
1. **Corte:** Tallo principal en oscuridad
2. **Secado:** 7-14 d√≠as, 18-21¬∞C, 45-55% humedad
3. **Manicurado:** En seco para mejor calidad
4. **Curado:** Frascos herm√©ticos, 60-65% humedad, 2-8 semanas

**Control de calidad medicinal:** Tests de cannabinoides y terpenos recomendados`;
                }

                if (lowerText.includes('nutrientes') || lowerText.includes('fertilizante')) {
                    return `**Plan nutricional para ${this.currentCultivo.variedad} en ${this.currentCultivo.medio}:**

**Vegetativo (semanas 1-6):**
- Base: NPK 20-10-10
- Cal-Mag: 1-2ml/L
- EC: 0.8-1.2 | pH: ${this.getpHRange()}

**Pre-floraci√≥n (semanas 7-8):**
- Transici√≥n: NPK 15-15-15
- Bloom booster inicio

**Floraci√≥n (semanas 9-16):**
- Base: NPK 10-30-20
- PK booster: semanas 10-14
- Enzimas y melaza para microbiolog√≠a

**Flush final:** Solo agua pH ajustado √∫ltimas 1-2 semanas`;
                }

                if (lowerText.includes('iluminacion') || lowerText.includes('luz') || lowerText.includes('led') || lowerText.includes('watts')) {
                    return `**An√°lisis de iluminaci√≥n para tu setup:**

**Tu configuraci√≥n actual:**
- Sistema: ${this.currentCultivo.iluminacion || 'No especificado'}
- Potencia: ${this.currentCultivo.potencia || '?'}W
- Espacio: ${this.currentCultivo.espacio}m¬≤
- Plantas: ${this.currentCultivo.plantas || '?'}

**Recomendaciones espec√≠ficas:**
${this.getLightingAdvice()}

**Optimizaci√≥n por fase:**
- **Vegetativo:** 18/6 | PPFD 200-400 Œºmol/m¬≤/s
- **Floraci√≥n:** 12/12 | PPFD 600-900 Œºmol/m¬≤/s
- **Distancia √≥ptima:** ${this.getLightDistance()}

¬øNecesitas ayuda con alg√∫n ajuste espec√≠fico?`;
                }

                if (lowerText.includes('ventilacion') || lowerText.includes('temperatura') || lowerText.includes('humedad') || lowerText.includes('aire')) {
                    return `**An√°lisis ambiental para tu cultivo:**

**Tu setup actual:**
- Ventilaci√≥n: ${this.currentCultivo.ventilacion || 'No especificado'}
- Control: ${this.currentCultivo.control || 'No especificado'}
- Espacio: ${this.currentCultivo.espacio}m¬≤
- M√©todo: ${this.currentCultivo.metodo}

**Par√°metros ideales:**
- **Vegetativo:** 22-26¬∞C | 40-60% HR
- **Floraci√≥n:** 18-24¬∞C | 30-45% HR
- **Renovaci√≥n de aire:** ${this.getAirflowAdvice()}

**Recomendaciones espec√≠ficas:**
${this.getEnvironmentalAdvice()}`;
                }

                if (lowerText.includes('maceta') || lowerText.includes('trasplante') || lowerText.includes('sustrato') || lowerText.includes('raiz')) {
                    return `**An√°lisis del sistema radicular:**

**Tu configuraci√≥n:**
- Macetas: ${this.currentCultivo.macetas || '?'}L
- Medio: ${this.currentCultivo.medio}
- Plantas: ${this.currentCultivo.plantas || '?'}
- Espacio por planta: ${this.getSpacePerPlant()}

**Recomendaciones:**
${this.getContainerAdvice()}

**Cronograma de trasplantes:**
- Semilla ‚Üí 0.5L (germinaci√≥n)
- Pl√°ntula ‚Üí 3-5L (vegetativo temprano)
- Vegetativo ‚Üí ${this.currentCultivo.macetas}L (final)
- **Timing:** Cuando las ra√≠ces cubran 80% del sustrato`;
                }

                if (lowerText.includes('entrenamiento') || lowerText.includes('poda') || lowerText.includes('lst') || lowerText.includes('scrog')) {
                    return `**T√©cnicas de entrenamiento para ${this.currentCultivo.variedad}:**

**Tu m√©todo actual:** ${this.currentCultivo.entrenamiento || 'Natural'}

**Recomendaciones espec√≠ficas:**
${this.getTrainingAdvice()}

**Cronograma √≥ptimo:**
- **Semana 3-4:** Inicio de t√©cnicas low-stress
- **Semana 5-6:** T√©cnicas high-stress (si aplica)
- **Pre-floraci√≥n:** √öltimos ajustes y defoliaci√≥n

**Para tu espacio (${this.currentCultivo.espacio}m¬≤):** ${this.getSpaceOptimizationTips()}`;
                }

                // Respuesta general con contexto del cultivo
                return `Como especialista en cannabis medicinal, analizo tu consulta sobre "${text}" para tu cultivo:

${context}

Para darte la respuesta m√°s precisa, ¬øpodr√≠as especificar:
- ¬øEn qu√© fase est√° tu cultivo actualmente?
- ¬øHay alg√∫n s√≠ntoma o problema espec√≠fico?
- ¬øBuscas informaci√≥n preventiva o correctiva?

Mi experiencia incluye cultivo medicinal de alta calidad, con enfoque en maximizar cannabinoides y terpenos para aplicaciones terap√©uticas espec√≠ficas.`;
            }

            getVarietySpecificTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('auto') || variedad.includes('autoflower')) {
                    return 'Germinar directo en maceta final, no trasplantar. Autofloreciente.';
                } else if (variedad.includes('indica') || variedad.includes('afghan') || variedad.includes('kush')) {
                    return 'Las √≠ndicas germinan m√°s lento pero son m√°s resistentes.';
                } else if (variedad.includes('sativa') || variedad.includes('thai') || variedad.includes('jamaican')) {
                    return 'Las sativas necesitan m√°s cuidado en germinaci√≥n, mayor temperatura.';
                } else {
                    return 'Comportamiento h√≠brido equilibrado, seguir protocolo est√°ndar.';
                }
            }

            getpHRange() {
                const medio = this.currentCultivo.medio;
                switch (medio) {
                    case 'fibra_coco':
                    case 'fibra_coco_perlita': return '5.5-6.2';
                    case 'light_mix': return '6.0-6.8';
                    case 'hidro': return '5.5-6.0';
                    default: return '6.0-6.5';
                }
            }

            getTherapeuticTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte') || variedad.includes('acdc')) {
                    return 'Variedad alta en CBD, ideal para usos medicinales con bajo psicoactivo.';
                } else if (variedad.includes('thc') || variedad.includes('gorilla') || variedad.includes('amnesia')) {
                    return 'Variedad alta en THC, enfocarse en control de dosis.';
                } else {
                    return 'Variedad equilibrada, monitorear perfil de cannabinoides durante floraci√≥n.';
                }
            }

            getHarvestTiming() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte')) {
                    return 'Cosechar cuando tricomas est√©n 50-60% lechosos para m√°ximo CBD.';
                } else if (variedad.includes('thc') || variedad.includes('skunk') || variedad.includes('haze')) {
                    return 'Esperar a que tricomas est√©n 70-80% lechosos para m√°ximo THC.';
                } else {
                    return 'Monitorear tricomas: 70% lechosos, 20% √°mbar, 10% transparentes para balance √≥ptimo.';
                }
            }

            analyzeCannabiImage(image, context) {
                return `He analizado la imagen de tu cultivo ${this.currentCultivo.nombre}.

**An√°lisis visual basado en:**
${context}

Puedo evaluar:
- **Estado de las hojas:** Color, textura, posibles deficiencias
- **Estructura de la planta:** Desarrollo, entrenudos
- **Flores/cogollos:** Madurez, densidad, tricomas
- **Problemas:** Plagas, enfermedades, estr√©s

**Para un diagn√≥stico m√°s preciso, describe:**
- ¬øQu√© problema espec√≠fico observas?
- ¬øCu√°ndo comenzaste a notarlo?
- ¬øCambios recientes en nutrici√≥n/ambiente?

Bas√°ndome en tu variedad ${this.currentCultivo.variedad} y m√©todo ${this.currentCultivo.metodo}, te dar√© recomendaciones espec√≠ficas.`;
            }

            analyzeCannabiImageWithText(text, image, context) {
                return `Perfecto, he analizado tu imagen junto con tu consulta: "${text}".

**Cultivo analizado:**
${context}

**An√°lisis combinado:**
Bas√°ndome en la imagen y tu descripci√≥n, puedo darte un diagn√≥stico m√°s preciso para tu ${this.currentCultivo.variedad}.

**Recomendaciones espec√≠ficas:**
- Evaluaci√≥n visual confirmada con tu descripci√≥n
- Protocolo de tratamiento adaptado a ${this.currentCultivo.metodo}
- Considerando objetivo terap√©utico: ${this.currentCultivo.objetivo}

**Pr√≥ximos pasos:**
1. Monitoreo diario de la evoluci√≥n
2. Ajustes espec√≠ficos seg√∫n diagn√≥stico
3. Seguimiento fotogr√°fico para comparar progreso

¬øNecesitas el protocolo detallado de tratamiento?`;
            }

            showWelcomeMessage() {
                this.chatHistory.innerHTML = `
                    <div class="message ai-message">
                        <div class="message-content">
                            <strong>üë®‚Äçüè´ Dr. Bruce Bugbee - Especialista en Cannabis Medicinal</strong>

                            <br><br>¬°Bienvenido al sistema de consulta especializada en cannabis medicinal!

                            <br><br><strong>Mi experiencia profesional:</strong>
                            ‚Ä¢ PhD en Bot√°nica y Farmacolog√≠a del Cannabis - Universidad de Colorado
                            ‚Ä¢ Director del Centro de Investigaci√≥n de Cannabis Medicinal
                            ‚Ä¢ 25+ a√±os investigando aplicaciones terap√©uticas
                            ‚Ä¢ Consultor para programas m√©dicos en m√∫ltiples estados
                            ‚Ä¢ Autor de protocolos cient√≠ficos de cultivo medicinal

                            <br><br><strong>Mi especializaci√≥n:</strong>
                            ‚Ä¢ Optimizaci√≥n de perfiles THC/CBD para tratamientos espec√≠ficos
                            ‚Ä¢ T√©cnicas de cultivo indoor de m√°xima calidad medicinal
                            ‚Ä¢ Investigaci√≥n de interacciones medicamento-cannabis
                            ‚Ä¢ Protocolos basados en evidencia cient√≠fica
                            ‚Ä¢ Recomendaciones personalizadas seg√∫n patolog√≠as

                            <br><br><strong>Para comenzar tu consulta:</strong>
                            <br>1. üìù Crea un nuevo cultivo con sus caracter√≠sticas espec√≠ficas
                            <br>2. üéØ Selecciona el cultivo para consultas contextualizadas
                            <br>3. üí¨ Realiza tus preguntas sobre cualquier aspecto del cultivo
                            <br>4. üì∏ Env√≠a fotos para diagn√≥stico visual profesional

                            <br><br><em>Cada cultivo mantiene su historial completo de consultas y observaciones para recomendaciones cada vez m√°s precisas.</em>
                        </div>
                    </div>
                `;
            }

            async loadCultivoNotes() {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const notes = result.data.notas || [];
                        if (this.cannabisChat) {
                            this.cannabisChat.setCultivoNotes(notes);
                            console.log('‚úÖ Notas del cultivo cargadas para contexto:', notes.length);
                        } else if (window.cannabisChat) {
                            this.cannabisChat = window.cannabisChat;
                            this.cannabisChat.setCultivoNotes(notes);
                            console.log('‚úÖ Notas del cultivo cargadas para contexto:', notes.length);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No se pudieron cargar las notas del cultivo');
                        if (this.cannabisChat) {
                            this.cannabisChat.setCultivoNotes([]);
                        } else if (window.cannabisChat) {
                            this.cannabisChat = window.cannabisChat;
                            this.cannabisChat.setCultivoNotes([]);
                        }
                    }
                } catch (error) {
                    console.error('Error cargando notas del cultivo:', error);
                    if (this.cannabisChat) {
                        this.cannabisChat.setCultivoNotes([]);
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCultivoNotes([]);
                    }
                }
            }

            loadCultivoChat() {
                this.chatHistory.innerHTML = '';

                // Mensaje de contexto del cultivo con Bruce Bugbee
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.addMessage(`**üå± Cultivo Seleccionado: ${this.currentCultivo.nombre}**

**üë®‚Äçüè´ Bruce Bugbee - Especialista en Cannabis Medicinal:**

Hola! Soy el Dr. Bruce Bugbee, profesor de la Universidad de Colorado y especialista en cannabis medicinal con m√°s de 25 a√±os de experiencia.

**üìã Detalles de tu cultivo:**
‚Ä¢ **Variedad**: ${this.currentCultivo.variedad}
‚Ä¢ **M√©todo**: Indoor profesional con CO2
‚Ä¢ **Medio**: ${medioDisplay[this.currentCultivo.medio] || this.currentCultivo.medio}
‚Ä¢ **Configuraci√≥n**: ${this.currentCultivo.espacio}m¬≤ | ${this.currentCultivo.plantas || '?'} plantas
‚Ä¢ **Iluminaci√≥n**: LED ${this.currentCultivo.potencia || '?'}W
‚Ä¢ **Objetivo**: Optimizaci√≥n de calidad medicinal

**üéØ Mi enfoque profesional:**
- Maximizar perfiles de cannabinoides y terpenos terap√©uticos
- Protocolos basados en evidencia cient√≠fica
- Recomendaciones espec√≠ficas para aplicaciones medicinales
- Consideraci√≥n del historial completo de tu cultivo

¬øEn qu√© aspecto de tu cultivo de cannabis medicinal puedo ayudarte hoy? Tengo acceso completo a tus notas y observaciones previas.`, 'ai');

                // Cargar historial previo desde la API
                if (this.currentCultivo.chatHistory && this.currentCultivo.chatHistory.length > 0) {
                    this.currentCultivo.chatHistory.forEach(msg => {
                        this.addMessage(msg.content, msg.type, msg.image);
                    });
                }
            }

            togglePanel(panel, open) {
                if (typeof open === 'undefined') {
                    open = !panel.classList.contains('open');
                }
                panel.classList.toggle('open', open);
                if (panel === this.infoPanel) {
                    this.openInfoBtn.style.display = open ? 'none' : 'block';
                } else if (panel === this.notesPanel) {
                    this.openNotesBtn.style.display = open ? 'none' : 'block';
                    if (open && this.currentCultivo) {
                        this.loadNotasFromAPI();
                    }
                }
            }

            updateInfoPanel() {
                if (!this.currentCultivo) {
                    this.infoContent.innerHTML = '<p>Selecciona un cultivo para ver la informaci√≥n.</p>';
                    this.notesArea.value = '';
                    return;
                }

                const c = this.currentCultivo;
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.infoContent.innerHTML = `
                    <h3>${c.nombre}</h3>
                    <p><strong>Variedad:</strong> ${c.variedad}</p>
                    <p><strong>M√©todo:</strong> Indoor | Medio: ${medioDisplay[c.medio] || c.medio}</p>
                    <p><strong>Setup:</strong> ${c.espacio}m¬≤ | ${c.plantas || '?'} plantas en macetas de ${c.macetas || '?'}L</p>
                    <p><strong>Iluminaci√≥n:</strong> LED (${c.potencia || '?'}W)</p>
                    <p><strong>Ventilaci√≥n:</strong> Sistema cerrado con CO2</p>
                `;

                // Mostrar notas recientes en el panel de informaci√≥n
                if (c.notasRecientes && c.notasRecientes.length > 0) {
                    const notasHTML = c.notasRecientes.map(nota => {
                        const fecha = new Date(nota.fecha).toLocaleDateString();
                        const tipoIcon = this.getTipoNotaIcon(nota.tipo);
                        return `<div class="nota-resumen ${nota.importante ? 'importante' : ''}">
                            <span class="nota-fecha">${fecha}</span>
                            <span class="nota-tipo">${tipoIcon}</span>
                            <span class="nota-contenido">${nota.contenido.substring(0, 50)}${nota.contenido.length > 50 ? '...' : ''}</span>
                        </div>`;
                    }).join('');

                    this.infoContent.innerHTML += `
                        <div class="notas-resumen">
                            <h4>üìù Notas Recientes</h4>
                            ${notasHTML}
                        </div>
                    `;
                }
            }

            async saveNotes() {
                if (!this.currentCultivo) return;

                // Obtener valores del formulario
                const tipoSelect = document.getElementById('note-type');
                const importanteCheckbox = document.getElementById('note-important');

                const tipo = tipoSelect ? tipoSelect.value : 'general';
                const importante = importanteCheckbox ? importanteCheckbox.checked : false;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contenido: this.notesArea.value,
                            tipo: tipo,
                            importante: importante
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.addMessage('‚úÖ Nota guardada exitosamente', 'ai');
                        // Actualizar el cultivo local con la nueva nota
                        if (!this.currentCultivo.notas) {
                            this.currentCultivo.notas = [];
                        }
                        this.currentCultivo.notas.push(result.data.nuevaNota);
                        // Limpiar el textarea despu√©s de guardar
                        this.notesArea.value = '';
                        // Actualizar el panel de informaci√≥n para mostrar las notas recientes
                        this.updateInfoPanel();
                        // Actualizar el panel lateral de notas si est√° abierto
                        this.updateNotesPanel();
                    } else {
                        const error = await response.json();
                        this.addMessage(`‚ùå Error guardando nota: ${error.error}`, 'ai');
                    }
                } catch (error) {
                    console.error('Error guardando nota:', error);
                    this.addMessage('‚ùå Error interno guardando nota', 'ai');
                }
            }

            getTipoNotaIcon(tipo) {
                const iconos = {
                    'general': 'üìù',
                    'vegetativo': 'üå±',
                    'floracion': 'üå∏',
                    'cosecha': '‚úÇÔ∏è',
                    'recordatorio': '‚è∞',
                    'comentario': 'üí¨'
                };
                return iconos[tipo] || 'üìù';
            }

            updateNotesPanel() {
                if (!this.currentCultivo || !this.notesPanel.classList.contains('open')) return;

                const notesContent = this.notesPanel.querySelector('.side-content');
                const notesList = notesContent.querySelector('.notes-list');

                if (notesList && this.currentCultivo.notas) {
                    notesList.innerHTML = this.renderNotasList(this.currentCultivo.notas);
                }
            }

            async loadNotasFromAPI() {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Actualizar las notas del cultivo con las de la API
                        this.currentCultivo.notas = result.data.notas;
                        this.updateNotesPanelUI();
                    } else {
                        console.error('Error cargando notas desde API:', response.status);
                    }
                } catch (error) {
                    console.error('Error cargando notas desde API:', error);
                }
            }

            updateNotesPanelUI() {
                const notesContent = this.notesPanel.querySelector('.side-content');
                if (!notesContent) return;

                notesContent.innerHTML = `
                    <div class="notes-history">
                        <div class="notes-header">
                            <h4>üìù Historial de Notas</h4>
                            <span class="notes-count">${this.currentCultivo.notas ? this.currentCultivo.notas.length : 0} notas</span>
                        </div>
                        <div class="notes-list">
                            ${this.renderNotasList(this.currentCultivo.notas || [])}
                        </div>
                        <div class="add-note-section">
                            <textarea id="notes-area" placeholder="Escribe una nueva nota..." rows="3"></textarea>
                            <div class="note-options">
                                <select id="note-type" class="note-type-select">
                                    <option value="general">üìù General</option>
                                    <option value="vegetativo">üå± Vegetativo</option>
                                    <option value="floracion">üå∏ Floraci√≥n</option>
                                    <option value="cosecha">‚úÇÔ∏è Cosecha</option>
                                    <option value="recordatorio">‚è∞ Recordatorio</option>
                                    <option value="comentario">üí¨ Comentario</option>
                                </select>
                                <label class="important-checkbox">
                                    <input type="checkbox" id="note-important"> Importante
                                </label>
                                <button id="save-notes" class="save-notes-btn">üíæ Guardar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Reasignar referencias despu√©s de recrear el DOM
                this.notesArea = document.getElementById('notes-area');
                this.saveNotesBtn = document.getElementById('save-notes');

                // Reasignar event listeners
                if (this.saveNotesBtn) {
                    this.saveNotesBtn.addEventListener('click', () => this.saveNotes());
                }
            }

            renderNotasList(notas) {
                if (!notas || notas.length === 0) {
                    return '<p class="no-notes">No hay notas a√∫n. ¬°Agrega la primera!</p>';
                }

                // Ordenar por fecha descendente (m√°s recientes primero)
                const notasOrdenadas = notas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                return notasOrdenadas.map(nota => {
                    const fecha = new Date(nota.fecha).toLocaleString();
                    const tipoIcon = this.getTipoNotaIcon(nota.tipo);
                    const tipoLabel = nota.tipo.charAt(0).toUpperCase() + nota.tipo.slice(1);
                    const importanteClass = nota.importante ? 'importante' : '';

                    return `
                        <div class="nota-item ${importanteClass}">
                            <div class="nota-header">
                                <span class="nota-tipo">${tipoIcon} ${tipoLabel}</span>
                                <span class="nota-fecha">${fecha}</span>
                                ${nota.importante ? '<span class="nota-importante">‚≠ê</span>' : ''}
                            </div>
                            <div class="nota-contenido">${nota.contenido}</div>
                            ${nota.fase ? `<div class="nota-fase">Fase: ${nota.fase}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            addMessage(content, sender, image = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                let messageContent = `
                    <div class="message-content">
                        <strong>${sender === 'user' ? 'T√∫' : 'Bruce'}:</strong> 
                `;

                if (image && sender === 'user') {
                    messageContent += `
                        <div class="message-image">
                            <img src="${image}" alt="Imagen enviada" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin: 8px 0;">
                        </div>
                    `;
                }

                if (content) {
                    messageContent += `<span>${content}</span>`;
                }

                messageContent += `
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                messageDiv.innerHTML = messageContent;
                this.chatHistory.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message typing-indicator';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <strong>Bruce:</strong> 
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                `;
                this.chatHistory.appendChild(typingDiv);
                this.scrollToBottom();
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            scrollToBottom() {
                this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            getLightingAdvice() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const wattsPerM2 = potencia / espacio;

                let advice = `Sistema LED de alta calidad para cultivo indoor.`;

                if (wattsPerM2 < 100) {
                    advice += ` Considera aumentar la potencia para mejor rendimiento (actual: ${wattsPerM2.toFixed(0)}W/m¬≤).`;
                } else if (wattsPerM2 > 300) {
                    advice += ` Potencia excelente (${wattsPerM2.toFixed(0)}W/m¬≤), asegurar buena ventilaci√≥n por el calor generado.`;
                } else {
                    advice += ` Potencia adecuada (${wattsPerM2.toFixed(0)}W/m¬≤) para buen desarrollo.`;
                }

                return advice;
            }

            getLightDistance() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                if (potencia <= 300) {
                    return '30-45cm (para LEDs de baja potencia)';
                } else if (potencia <= 600) {
                    return '45-60cm (para LEDs de media potencia)';
                } else {
                    return '60-80cm (para LEDs de alta potencia, ajustar por calor)';
                }
            }

            getAirflowAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const volumen = espacio * 2.5; // Asumiendo 2.5m de altura
                const renovacionPorMinuto = volumen * 1.5; // 1.5 veces por minuto
                return `${renovacionPorMinuto.toFixed(0)} m¬≥/min para tu espacio de ${volumen}m¬≥`;
            }

            getEnvironmentalAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                let advice = 'Sistema cerrado con CO2 √≥ptimo para control de ambiente. ';

                if (potencia > 600) {
                    advice += 'Alta potencia requiere buena renovaci√≥n de aire para controlar temperatura.';
                } else {
                    advice += 'Mant√©n CO2 entre 800-1200ppm para m√°ximo rendimiento.';
                }

                advice += ' Monitoreo constante de temperatura y humedad recomendado.';

                return advice;
            }

            getSpacePerPlant() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const spacePer = (espacio / plantas);
                return `${spacePer.toFixed(2)}m¬≤ por planta`;
            }

            getContainerAdvice() {
                const macetas = parseInt(this.currentCultivo.macetas) || 0;
                const medio = this.currentCultivo.medio;

                let advice = '';

                // Recomendaciones basadas en tama√±o de macetas
                if (macetas < 11) {
                    advice = 'Para buen desarrollo radicular, considerar macetas de 11L o m√°s (actual: ' + macetas + 'L). ';
                } else if (macetas >= 50) {
                    advice = 'Macetas grandes excelentes para desarrollo completo (actual: ' + macetas + 'L). ';
                }

                // Recomendaciones basadas en medio
                if (medio === 'fibra_coco' || medio === 'fibra_coco_perlita') {
                    advice += 'Fibra de coco drena excelente, permite buen control de humedad.';
                } else if (medio === 'light_mix') {
                    advice += 'Light mix retiene nutrientes bien, monitorear pH regularmente.';
                } else if (medio === 'hidro') {
                    advice += 'Sistema hidrop√≥nico requiere recirculaci√≥n constante.';
                }

                return advice;
            }

            getTrainingAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const densidad = espacio / plantas;

                let advice = '';

                if (densidad > 1) {
                    advice = `Espacio generoso (${densidad.toFixed(1)}m¬≤/planta). Ideal para t√©cnicas LST o SCROG para maximizar rendimiento.`;
                } else if (densidad < 0.5) {
                    advice = `Espacio limitado. Considera t√©cnicas SOG o plantas m√°s compactas.`;
                } else {
                    advice = `Densidad equilibrada. Cualquier t√©cnica de entrenamiento funcionar√° bien.`;
                }

                advice += ` Recomiendo LST (Low Stress Training) para principiantes - comenzar en semana 3-4.`;

                return advice;
            }

            getSpaceOptimizationTips() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;

                if (espacio / plantas > 1) {
                    return 'Espacio generoso, ideal para t√©cnicas LST/SCROG.';
                } else if (espacio / plantas < 0.5) {
                    return 'Espacio limitado, considera SOG o plantas m√°s peque√±as.';
                } else {
                    return 'Densidad equilibrada, cualquier t√©cnica funcionar√° bien.';
                }
            }
        }

        // Estilos para autenticaci√≥n
        const authStyles = `
            <style>
                .auth-status {
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .user-info {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px 16px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 20px;
                    font-size: 14px;
                }

                .logout-btn, .login-btn, .auto-login-btn {
                    padding: 6px 12px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.3s ease;
                }

                .logout-btn {
                    background: #dc3545;
                    color: white;
                }

                .logout-btn:hover {
                    background: #c82333;
                }

                .login-btn {
                    background: #007bff;
                    color: white;
                }

                .login-btn:hover {
                    background: #0056b3;
                }

                .auto-login-btn {
                    background: #28a745;
                    color: white;
                }

                .auto-login-btn:hover {
                    background: #1e7e34;
                }

                /* Estilos para notas */
                .notas-resumen {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }

                .notas-resumen h4 {
                    margin: 0 0 10px 0;
                    color: #4CAF50;
                    font-size: 14px;
                }

                .nota-resumen {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 6px 0;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                    font-size: 12px;
                }

                .nota-resumen.importante {
                    background: rgba(255, 193, 7, 0.1);
                    border-left: 3px solid #ffc107;
                }

                .nota-fecha {
                    color: #888;
                    flex-shrink: 0;
                }

                .nota-tipo {
                    flex-shrink: 0;
                }

                .nota-contenido {
                    flex: 1;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                /* Panel lateral de notas */
                .notes-history {
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                }

                .notes-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }

                .notes-header h4 {
                    margin: 0;
                    color: #4CAF50;
                }

                .notes-count {
                    font-size: 12px;
                    color: #888;
                }

                .notes-list {
                    flex: 1;
                    overflow-y: auto;
                    margin-bottom: 20px;
                }

                .nota-item {
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 10px;
                    border-left: 3px solid #4CAF50;
                }

                .nota-item.importante {
                    border-left-color: #ffc107;
                    background: rgba(255, 193, 7, 0.1);
                }

                .nota-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                    font-size: 12px;
                }

                .nota-tipo {
                    font-weight: bold;
                }

                .nota-fecha {
                    color: #888;
                }

                .nota-importante {
                    color: #ffc107;
                }

                .nota-contenido {
                    margin-bottom: 5px;
                    line-height: 1.4;
                }

                .nota-fase {
                    font-size: 11px;
                    color: #4CAF50;
                    font-style: italic;
                }

                .no-notes {
                    text-align: center;
                    color: #888;
                    font-style: italic;
                    padding: 20px;
                }

                .add-note-section {
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    padding-top: 15px;
                }

                .add-note-section textarea {
                    width: 100%;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 6px;
                    padding: 10px;
                    color: white;
                    font-family: inherit;
                    resize: vertical;
                    margin-bottom: 10px;
                }

                .add-note-section textarea::placeholder {
                    color: #888;
                }

                .note-options {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    flex-wrap: wrap;
                }

                .note-type-select {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 4px;
                    padding: 6px 8px;
                    color: white;
                    font-size: 12px;
                }

                .important-checkbox {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-size: 12px;
                    color: #ccc;
                }

                .important-checkbox input[type="checkbox"] {
                    margin: 0;
                }

                .save-notes-btn {
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background 0.3s;
                }

                .save-notes-btn:hover {
                    background: #45a049;
                }
            </style>
        `;

        // Agregar estilos al head
        document.head.insertAdjacentHTML('beforeend', authStyles);

        // Inicializar Bruce AI cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar men√∫ hamburguesa para m√≥viles
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');

            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navToggle.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });

                // Cerrar men√∫ cuando se hace click en un enlace
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    });
                });

                // Cerrar men√∫ cuando se hace click fuera de √©l
                document.addEventListener('click', function(e) {
                    if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    }
                });
            }

            new BruceAI();
        });
    </script>
</body>

</html>