<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruce - Fede Life</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    <link rel="stylesheet" href="app.css">
</head>

<body>
       <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-title">Fede Life</span>
            </div>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="finanzas.html" >Finanzas</a></li>
                <li><a href="tareas.html">Tareas</a></li>
                <li><a href="bruce.html" class="active">Bruce</a></li>
            </ul>
        </div>
    </nav>
    <header>
        <h1>Preguntale a Bruce</h1>

    </header>
    <main>
        <section class="chat-container">
            <div id="chat-history" class="chat-history">
                <div class="message ai-message">
                    <div class="message-content">
                        <strong>Bruce:</strong> ¬°Hola! Soy Bruce, tu asistente IA. Puedes enviarme texto o im√°genes y te
                        responder√© con informaci√≥n √∫til. ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-area">
                    <textarea id="user-input" placeholder="Escribe tu mensaje aqu√≠..." rows="3"></textarea>
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                    <div class="image-preview" id="image-preview" style="display: none;">
                        <img id="preview-img" src="" alt="Vista previa">
                        <button id="remove-image" class="remove-btn">&times;</button>
                    </div>
                </div>
                <div class="controls">
                    <button id="attach-image" class="attach-btn" title="Adjuntar imagen">üìé</button>
                    <button id="send-message" class="send-btn">Enviar</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Botones para abrir modales laterales -->
    <button id="open-info" class="side-toggle left">‚ÑπÔ∏è</button>
    <button id="open-notes" class="side-toggle right">üìù</button>

    <!-- Modal lateral izquierdo: informaci√≥n del cultivo -->
    <div id="cultivo-info" class="side-modal left">
        <div class="side-header">
            <span>Informaci√≥n del Cultivo</span>
            <button class="close-btn" data-target="cultivo-info">&times;</button>
        </div>
        <div id="cultivo-info-content" class="side-content">
            <p>Selecciona un cultivo para ver la informaci√≥n.</p>
        </div>
    </div>

    <!-- Modal lateral derecho: notas del cultivo -->
    <div id="cultivo-notes" class="side-modal right">
        <div class="side-header">
            <span>Notas del Cultivo</span>
            <button class="close-btn" data-target="cultivo-notes">&times;</button>
        </div>
        <div class="side-content">
            <textarea id="notes-area" placeholder="Escribe tus notas aqu√≠..."></textarea>
            <button id="save-notes" class="save-notes-btn">Guardar</button>
        </div>
    </div>

    <footer>
        <p>&copy; Desde 1992 Fede Life. Todos los derechos reservados, dec√≠a</p>
    </footer>

    <script>
        class BruceAI {
            constructor() {
                this.chatHistory = document.getElementById('chat-history');
                this.userInput = document.getElementById('user-input');
                this.imageInput = document.getElementById('image-input');
                this.imagePreview = document.getElementById('image-preview');
                this.previewImg = document.getElementById('preview-img');
                this.sendButton = document.getElementById('send-message');
                this.attachButton = document.getElementById('attach-image');
                this.removeImageButton = document.getElementById('remove-image');

                this.infoPanel = document.getElementById('cultivo-info');
                this.notesPanel = document.getElementById('cultivo-notes');
                this.openInfoBtn = document.getElementById('open-info');
                this.openNotesBtn = document.getElementById('open-notes');
                this.notesArea = document.getElementById('notes-area');
                this.saveNotesBtn = document.getElementById('save-notes');
                this.infoContent = document.getElementById('cultivo-info-content');

                this.currentImage = null;
                this.currentCultivo = null;
                this.cultivos = {};

                this.initializeEventListeners();
                this.loadCultivos().then(() => {
                    this.initializeCultivoSelector();
                    this.updateCultivoDropdown();
                    this.showWelcomeMessage();
                    this.updateInfoPanel();
                });
            }

            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.attachButton.addEventListener('click', () => {
                    this.imageInput.click();
                });

                this.imageInput.addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                this.removeImageButton.addEventListener('click', () => {
                    this.removeImage();
                });

                this.openInfoBtn.addEventListener('click', () => this.togglePanel(this.infoPanel, true));
                this.openNotesBtn.addEventListener('click', () => this.togglePanel(this.notesPanel, true));
                this.infoPanel
                    .querySelector('.close-btn')
                    .addEventListener('click', () => this.togglePanel(this.infoPanel, false));
                this.notesPanel
                    .querySelector('.close-btn')
                    .addEventListener('click', () => this.togglePanel(this.notesPanel, false));
                this.saveNotesBtn.addEventListener('click', () => this.saveNotes());
            }

            // Gesti√≥n de cultivos con API
            async loadCultivos() {
                try {
                    const response = await fetch('/api/cultivos', {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.cultivos = {};
                        result.data.forEach(cultivo => {
                            this.cultivos[cultivo.id] = cultivo;
                        });
                        return this.cultivos;
                    } else {
                        console.error('Error cargando cultivos:', response.status);
                        return {};
                    }
                } catch (error) {
                    console.error('Error cargando cultivos:', error);
                    return {};
                }
            }

            getAuthToken() {
                // Obtener token de autenticaci√≥n (puedes ajustarlo seg√∫n tu sistema)
                return localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
            }

            initializeCultivoSelector() {
                const selectorContainer = document.createElement('div');
                selectorContainer.className = 'cultivo-selector';
                selectorContainer.innerHTML = `
                    <div class="cultivo-controls">
                        <select id="cultivo-select" class="cultivo-dropdown">
                            <option value="">Seleccionar cultivo...</option>
                        </select>
                        <button id="new-cultivo-btn" class="new-cultivo-btn">+ Nuevo Cultivo</button>
                        <button id="edit-cultivo-btn" class="edit-cultivo-btn" style="display: none;">‚úèÔ∏è Editar</button>
                        <button id="delete-cultivo-btn" class="delete-cultivo-btn" style="display: none;">üóëÔ∏è</button>
                    </div>
                `;

                this.chatHistory.parentNode.insertBefore(selectorContainer, this.chatHistory);

                this.cultivoSelect = document.getElementById('cultivo-select');
                this.newCultivoBtn = document.getElementById('new-cultivo-btn');
                this.editCultivoBtn = document.getElementById('edit-cultivo-btn');
                this.deleteCultivoBtn = document.getElementById('delete-cultivo-btn');

                this.cultivoSelect.addEventListener('change', (e) => this.selectCultivo(e.target.value));
                this.newCultivoBtn.addEventListener('click', () => this.createNewCultivo());
                this.editCultivoBtn.addEventListener('click', () => this.editCultivo());
                this.deleteCultivoBtn.addEventListener('click', () => this.deleteCultivo());

                this.updateCultivoDropdown();
            }

            updateCultivoDropdown() {
                const select = this.cultivoSelect;
                select.innerHTML = '<option value="">Seleccionar cultivo...</option>';

                Object.keys(this.cultivos).forEach(id => {
                    const cultivo = this.cultivos[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${cultivo.nombre} (${cultivo.variedad})`;
                    select.appendChild(option);
                });
            }

            async selectCultivo(cultivoId) {
                if (cultivoId) {
                    // Si no tenemos el cultivo en memoria, cargarlo desde la API
                    if (!this.cultivos[cultivoId]) {
                        try {
                            const response = await fetch(`/api/cultivos/${cultivoId}`, {
                                headers: {
                                    'Authorization': `Bearer ${this.getAuthToken()}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                const result = await response.json();
                                this.cultivos[cultivoId] = result.data;
                            } else {
                                console.error('Error cargando cultivo espec√≠fico:', response.status);
                                return;
                            }
                        } catch (error) {
                            console.error('Error cargando cultivo espec√≠fico:', error);
                            return;
                        }
                    }

                    this.currentCultivo = this.cultivos[cultivoId];
                    this.editCultivoBtn.style.display = 'inline-block';
                    this.deleteCultivoBtn.style.display = 'inline-block';
                    this.loadCultivoChat();
                    this.updateInfoPanel();
                } else {
                    this.currentCultivo = null;
                    this.editCultivoBtn.style.display = 'none';
                    this.deleteCultivoBtn.style.display = 'none';
                    this.showWelcomeMessage();
                    this.updateInfoPanel();
                }
            }

            async createNewCultivo() {
                const cultivoData = await this.promptCultivoData();
                if (cultivoData) {
                    try {
                        const response = await fetch('/api/cultivos', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[cultivo.id] = cultivo;
                            this.updateCultivoDropdown();
                            this.cultivoSelect.value = cultivo.id;
                            this.selectCultivo(cultivo.id);
                            this.addMessage('‚úÖ Cultivo creado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error creando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error creando cultivo:', error);
                        this.addMessage('‚ùå Error interno creando cultivo', 'ai');
                    }
                }
            }

            async editCultivo() {
                if (!this.currentCultivo) return;

                const cultivoData = await this.promptCultivoData(this.currentCultivo);
                if (cultivoData) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[this.currentCultivo.id] = cultivo;
                            this.currentCultivo = cultivo;
                            this.updateCultivoDropdown();
                            this.loadCultivoChat();
                            this.updateInfoPanel();
                            this.addMessage('‚úÖ Cultivo actualizado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error actualizando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error actualizando cultivo:', error);
                        this.addMessage('‚ùå Error interno actualizando cultivo', 'ai');
                    }
                }
            }

            async deleteCultivo() {
                if (!this.currentCultivo) return;

                if (confirm(`¬øEst√°s seguro de eliminar el cultivo "${this.currentCultivo.nombre}"?`)) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}?archive=true`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            delete this.cultivos[this.currentCultivo.id];
                            this.updateCultivoDropdown();
                            this.currentCultivo = null;
                            this.editCultivoBtn.style.display = 'none';
                            this.deleteCultivoBtn.style.display = 'none';
                            this.showWelcomeMessage();
                            this.updateInfoPanel();
                            this.addMessage('‚úÖ Cultivo archivado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`‚ùå Error eliminando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error eliminando cultivo:', error);
                        this.addMessage('‚ùå Error interno eliminando cultivo', 'ai');
                    }
                }
            }

            async promptCultivoData(existingData = {}) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'cultivo-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>${existingData.id ? 'Editar' : 'Nuevo'} Cultivo de Cannabis Medicinal</h3>
                            <form id="cultivo-form">
                                <div class="form-group">
                                    <label>Nombre del cultivo:</label>
                                    <input type="text" id="nombre" value="${existingData.nombre || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Variedad/Cepa:</label>
                                    <input type="text" id="variedad" value="${existingData.variedad || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Medio de cultivo:</label>
                                    <select id="medio" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="fibra_coco" ${existingData.medio === 'fibra_coco' ? 'selected' : ''}>Fibra de coco</option>
                                        <option value="fibra_coco_perlita" ${existingData.medio === 'fibra_coco_perlita' ? 'selected' : ''}>Fibra de coco + perlita</option>
                                        <option value="light_mix" ${existingData.medio === 'light_mix' ? 'selected' : ''}>Light mix</option>
                                        <option value="hidro" ${existingData.medio === 'hidro' ? 'selected' : ''}>Hidro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Espacio de cultivo (m¬≤):</label>
                                    <input type="number" id="espacio" value="${existingData.espacio || ''}" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label>Tama√±o de macetas (L):</label>
                                    <input type="number" id="macetas" value="${existingData.macetas || ''}" step="1" placeholder="ej: 11, 20, 50..." required>
                                </div>
                                <div class="form-group">
                                    <label>Potencia lum√≠nica (W):</label>
                                    <input type="number" id="potencia" value="${existingData.potencia || ''}" placeholder="ej: 240, 600, 1000..." required>
                                </div>
                                <div class="form-group">
                                    <label>N√∫mero de plantas:</label>
                                    <input type="number" id="plantas" value="${existingData.plantas || ''}" min="1" placeholder="ej: 1, 4, 9..." required>
                                </div>
                                <div class="form-group">
                                    <label>Notas adicionales:</label>
                                    <textarea id="notas" rows="3" placeholder="Detalles espec√≠ficos, objetivos, observaciones...">${existingData.notas || ''}</textarea>
                                </div>
                                <div class="form-buttons">
                                    <button type="submit">${existingData.id ? 'Actualizar' : 'Crear'} Cultivo</button>
                                    <button type="button" onclick="this.closest('.cultivo-modal').remove()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    document.getElementById('cultivo-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const cultivoData = {
                            nombre: formData.get('nombre') || document.getElementById('nombre').value,
                            variedad: formData.get('variedad') || document.getElementById('variedad').value,
                            metodo: 'indoor', // Siempre indoor
                            medio: formData.get('medio') || document.getElementById('medio').value,
                            espacio: formData.get('espacio') || document.getElementById('espacio').value,
                            macetas: formData.get('macetas') || document.getElementById('macetas').value,
                            iluminacion: 'led', // Siempre LED
                            potencia: formData.get('potencia') || document.getElementById('potencia').value,
                            ventilacion: 'sistema_cerrado_co2', // Siempre sistema cerrado con CO2
                            plantas: formData.get('plantas') || document.getElementById('plantas').value,
                            notas: formData.get('notas') || document.getElementById('notas').value
                        };
                        modal.remove();
                        resolve(cultivoData);
                    });
                });
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentImage = e.target.result;
                        this.previewImg.src = this.currentImage;
                        this.imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            removeImage() {
                this.currentImage = null;
                this.previewImg.src = '';
                this.imagePreview.style.display = 'none';
                this.imageInput.value = '';
            }

            async sendMessage() {
                const message = this.userInput.value.trim();
                if (!message && !this.currentImage) return;

                if (!this.currentCultivo) {
                    this.addMessage('Por favor selecciona o crea un cultivo antes de hacer consultas.', 'ai');
                    return;
                }

                // Mostrar mensaje del usuario
                this.addMessage(message, 'user', this.currentImage);

                // Limpiar input
                this.userInput.value = '';
                const imageToProcess = this.currentImage;
                this.removeImage();

                // Mostrar indicador de typing
                this.showTypingIndicator();

                try {
                    // Procesar con IA especializada
                    const response = await this.processWithCannabiAI(message, imageToProcess);
                    this.removeTypingIndicator();
                    this.addMessage(response, 'ai');

                    // Guardar mensajes en la API
                    await this.saveChatMessage('user', message, imageToProcess);
                    await this.saveChatMessage('ai', response);
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addMessage('Lo siento, hubo un error procesando tu consulta. Por favor intenta de nuevo.', 'ai');
                    console.error('Error:', error);
                }
            }

            async saveChatMessage(type, content, image = null) {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type,
                            content,
                            image
                        })
                    });

                    if (!response.ok) {
                        console.error('Error guardando mensaje en chat:', response.status);
                    }
                } catch (error) {
                    console.error('Error guardando mensaje en chat:', error);
                }
            }

            async processWithCannabiAI(text, image) {
                await this.delay(1000 + Math.random() * 2000);

                const cultivo = this.currentCultivo;
                const context = this.buildCultivoContext(cultivo);

                if (image && text) {
                    return this.analyzeCannabiImageWithText(text, image, context);
                } else if (image) {
                    return this.analyzeCannabiImage(image, context);
                } else {
                    return this.processCannabiText(text, context);
                }
            }

            buildCultivoContext(cultivo) {
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                return `
Cultivo: ${cultivo.nombre}
Variedad: ${cultivo.variedad}
M√©todo: Indoor
Medio: ${medioDisplay[cultivo.medio] || cultivo.medio}
Espacio: ${cultivo.espacio}m¬≤
Macetas: ${cultivo.macetas}L
Plantas: ${cultivo.plantas}
Iluminaci√≥n: LED (${cultivo.potencia}W)
Ventilaci√≥n: Sistema cerrado con CO2
Fecha de inicio: ${new Date(cultivo.fechaCreacion).toLocaleDateString()}
Notas: ${cultivo.notas || 'Sin notas adicionales'}
                `.trim();
            }

            processCannabiText(text, context) {
                const lowerText = text.toLowerCase();

                // Respuestas espec√≠ficas sobre cultivo de cannabis medicinal
                if (lowerText.includes('germina') || lowerText.includes('semilla')) {
                    return `Para tu cultivo ${this.currentCultivo.nombre} (${this.currentCultivo.variedad}), te recomiendo:

**Germinaci√≥n de semillas:**
- M√©todo del papel h√∫medo: 24-72 horas en lugar oscuro a 22-25¬∞C
- Trasplante cuando la rad√≠cula mida 1-2cm
- Para ${this.currentCultivo.tipo}: ${this.getVarietySpecificTips()}
- Humedad: 70-80% durante germinaci√≥n

¬øNecesitas detalles espec√≠ficos sobre alg√∫n paso?`;
                }

                if (lowerText.includes('vegetativo') || lowerText.includes('crecimiento')) {
                    return `**Fase vegetativa para ${this.currentCultivo.variedad}:**

**Condiciones ambientales:**
- Temperatura: 20-26¬∞C
- Humedad: 40-60%
- Fotoper√≠odo: 18/6 horas (luz/oscuridad)
- pH ${this.currentCultivo.medio}: ${this.getpHRange()}

**Nutrici√≥n:**
- NPK alto en Nitr√≥geno (ej: 20-10-10)
- Riego: cuando los primeros 2cm de sustrato est√©n secos
- EC: 0.8-1.2 para ${this.currentCultivo.medio}

**Para tu objetivo de ${this.currentCultivo.objetivo}:** ${this.getTherapeuticTips()}`;
                }

                if (lowerText.includes('floracion') || lowerText.includes('cogollos')) {
                    return `**Floraci√≥n de ${this.currentCultivo.variedad}:**

**Cambios necesarios:**
- Fotoper√≠odo: 12/12 horas ${this.currentCultivo.tipo === 'autoflower' ? '(No necesario para autoflorecientes)' : ''}
- Temperatura: 18-24¬∞C
- Humedad: 30-45% (prevenir moho)

**Nutrici√≥n:**
- NPK alto en F√≥sforo y Potasio (ej: 10-30-20)
- Cal-Mag suplementario
- Flush final: 1-2 semanas antes de cosecha

**Se√±ales de madurez:** Tricomas lechosos al 70-80% para efectos terap√©uticos`;
                }

                if (lowerText.includes('problema') || lowerText.includes('enfermedad') || lowerText.includes('plaga')) {
                    return `**Diagn√≥stico para ${this.currentCultivo.nombre}:**

**Problemas comunes en ${this.currentCultivo.metodo}:**
- **Nutritivos:** Deficiencias de N, P, K, Cal-Mag
- **Ambientales:** Temperatura, humedad, ventilaci√≥n
- **Plagas:** Ara√±a roja, trips, pulgones, mosca blanca
- **Hongos:** O√≠dio, botrytis, fusarium

**Describe los s√≠ntomas espec√≠ficos** (color hojas, manchas, insectos visibles) y te dar√© un diagn√≥stico preciso con tratamiento org√°nico adecuado para cannabis medicinal.

¬øPuedes enviar una foto del problema?`;
                }

                if (lowerText.includes('cosecha') || lowerText.includes('secar') || lowerText.includes('curado')) {
                    return `**Cosecha y post-cosecha para ${this.currentCultivo.variedad}:**

**Momento √≥ptimo:**
- Tricomas: 70% lechosos, 20% √°mbar, 10% transparentes
- Para ${this.currentCultivo.objetivo}: ${this.getHarvestTiming()}

**Proceso:**
1. **Corte:** Tallo principal en oscuridad
2. **Secado:** 7-14 d√≠as, 18-21¬∞C, 45-55% humedad
3. **Manicurado:** En seco para mejor calidad
4. **Curado:** Frascos herm√©ticos, 60-65% humedad, 2-8 semanas

**Control de calidad medicinal:** Tests de cannabinoides y terpenos recomendados`;
                }

                if (lowerText.includes('nutrientes') || lowerText.includes('fertilizante')) {
                    return `**Plan nutricional para ${this.currentCultivo.variedad} en ${this.currentCultivo.medio}:**

**Vegetativo (semanas 1-6):**
- Base: NPK 20-10-10
- Cal-Mag: 1-2ml/L
- EC: 0.8-1.2 | pH: ${this.getpHRange()}

**Pre-floraci√≥n (semanas 7-8):**
- Transici√≥n: NPK 15-15-15
- Bloom booster inicio

**Floraci√≥n (semanas 9-16):**
- Base: NPK 10-30-20
- PK booster: semanas 10-14
- Enzimas y melaza para microbiolog√≠a

**Flush final:** Solo agua pH ajustado √∫ltimas 1-2 semanas`;
                }

                if (lowerText.includes('iluminacion') || lowerText.includes('luz') || lowerText.includes('led') || lowerText.includes('watts')) {
                    return `**An√°lisis de iluminaci√≥n para tu setup:**

**Tu configuraci√≥n actual:**
- Sistema: ${this.currentCultivo.iluminacion || 'No especificado'}
- Potencia: ${this.currentCultivo.potencia || '?'}W
- Espacio: ${this.currentCultivo.espacio}m¬≤
- Plantas: ${this.currentCultivo.plantas || '?'}

**Recomendaciones espec√≠ficas:**
${this.getLightingAdvice()}

**Optimizaci√≥n por fase:**
- **Vegetativo:** 18/6 | PPFD 200-400 Œºmol/m¬≤/s
- **Floraci√≥n:** 12/12 | PPFD 600-900 Œºmol/m¬≤/s
- **Distancia √≥ptima:** ${this.getLightDistance()}

¬øNecesitas ayuda con alg√∫n ajuste espec√≠fico?`;
                }

                if (lowerText.includes('ventilacion') || lowerText.includes('temperatura') || lowerText.includes('humedad') || lowerText.includes('aire')) {
                    return `**An√°lisis ambiental para tu cultivo:**

**Tu setup actual:**
- Ventilaci√≥n: ${this.currentCultivo.ventilacion || 'No especificado'}
- Control: ${this.currentCultivo.control || 'No especificado'}
- Espacio: ${this.currentCultivo.espacio}m¬≤
- M√©todo: ${this.currentCultivo.metodo}

**Par√°metros ideales:**
- **Vegetativo:** 22-26¬∞C | 40-60% HR
- **Floraci√≥n:** 18-24¬∞C | 30-45% HR
- **Renovaci√≥n de aire:** ${this.getAirflowAdvice()}

**Recomendaciones espec√≠ficas:**
${this.getEnvironmentalAdvice()}`;
                }

                if (lowerText.includes('maceta') || lowerText.includes('trasplante') || lowerText.includes('sustrato') || lowerText.includes('raiz')) {
                    return `**An√°lisis del sistema radicular:**

**Tu configuraci√≥n:**
- Macetas: ${this.currentCultivo.macetas || '?'}L
- Medio: ${this.currentCultivo.medio}
- Plantas: ${this.currentCultivo.plantas || '?'}
- Espacio por planta: ${this.getSpacePerPlant()}

**Recomendaciones:**
${this.getContainerAdvice()}

**Cronograma de trasplantes:**
- Semilla ‚Üí 0.5L (germinaci√≥n)
- Pl√°ntula ‚Üí 3-5L (vegetativo temprano)
- Vegetativo ‚Üí ${this.currentCultivo.macetas}L (final)
- **Timing:** Cuando las ra√≠ces cubran 80% del sustrato`;
                }

                if (lowerText.includes('entrenamiento') || lowerText.includes('poda') || lowerText.includes('lst') || lowerText.includes('scrog')) {
                    return `**T√©cnicas de entrenamiento para ${this.currentCultivo.variedad}:**

**Tu m√©todo actual:** ${this.currentCultivo.entrenamiento || 'Natural'}

**Recomendaciones espec√≠ficas:**
${this.getTrainingAdvice()}

**Cronograma √≥ptimo:**
- **Semana 3-4:** Inicio de t√©cnicas low-stress
- **Semana 5-6:** T√©cnicas high-stress (si aplica)
- **Pre-floraci√≥n:** √öltimos ajustes y defoliaci√≥n

**Para tu espacio (${this.currentCultivo.espacio}m¬≤):** ${this.getSpaceOptimizationTips()}`;
                }

                // Respuesta general con contexto del cultivo
                return `Como especialista en cannabis medicinal, analizo tu consulta sobre "${text}" para tu cultivo:

${context}

Para darte la respuesta m√°s precisa, ¬øpodr√≠as especificar:
- ¬øEn qu√© fase est√° tu cultivo actualmente?
- ¬øHay alg√∫n s√≠ntoma o problema espec√≠fico?
- ¬øBuscas informaci√≥n preventiva o correctiva?

Mi experiencia incluye cultivo medicinal de alta calidad, con enfoque en maximizar cannabinoides y terpenos para aplicaciones terap√©uticas espec√≠ficas.`;
            }

            getVarietySpecificTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('auto') || variedad.includes('autoflower')) {
                    return 'Germinar directo en maceta final, no trasplantar. Autofloreciente.';
                } else if (variedad.includes('indica') || variedad.includes('afghan') || variedad.includes('kush')) {
                    return 'Las √≠ndicas germinan m√°s lento pero son m√°s resistentes.';
                } else if (variedad.includes('sativa') || variedad.includes('thai') || variedad.includes('jamaican')) {
                    return 'Las sativas necesitan m√°s cuidado en germinaci√≥n, mayor temperatura.';
                } else {
                    return 'Comportamiento h√≠brido equilibrado, seguir protocolo est√°ndar.';
                }
            }

            getpHRange() {
                const medio = this.currentCultivo.medio;
                switch (medio) {
                    case 'fibra_coco':
                    case 'fibra_coco_perlita': return '5.5-6.2';
                    case 'light_mix': return '6.0-6.8';
                    case 'hidro': return '5.5-6.0';
                    default: return '6.0-6.5';
                }
            }

            getTherapeuticTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte') || variedad.includes('acdc')) {
                    return 'Variedad alta en CBD, ideal para usos medicinales con bajo psicoactivo.';
                } else if (variedad.includes('thc') || variedad.includes('gorilla') || variedad.includes('amnesia')) {
                    return 'Variedad alta en THC, enfocarse en control de dosis.';
                } else {
                    return 'Variedad equilibrada, monitorear perfil de cannabinoides durante floraci√≥n.';
                }
            }

            getHarvestTiming() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte')) {
                    return 'Cosechar cuando tricomas est√©n 50-60% lechosos para m√°ximo CBD.';
                } else if (variedad.includes('thc') || variedad.includes('skunk') || variedad.includes('haze')) {
                    return 'Esperar a que tricomas est√©n 70-80% lechosos para m√°ximo THC.';
                } else {
                    return 'Monitorear tricomas: 70% lechosos, 20% √°mbar, 10% transparentes para balance √≥ptimo.';
                }
            }

            analyzeCannabiImage(image, context) {
                return `He analizado la imagen de tu cultivo ${this.currentCultivo.nombre}.

**An√°lisis visual basado en:**
${context}

Puedo evaluar:
- **Estado de las hojas:** Color, textura, posibles deficiencias
- **Estructura de la planta:** Desarrollo, entrenudos
- **Flores/cogollos:** Madurez, densidad, tricomas
- **Problemas:** Plagas, enfermedades, estr√©s

**Para un diagn√≥stico m√°s preciso, describe:**
- ¬øQu√© problema espec√≠fico observas?
- ¬øCu√°ndo comenzaste a notarlo?
- ¬øCambios recientes en nutrici√≥n/ambiente?

Bas√°ndome en tu variedad ${this.currentCultivo.variedad} y m√©todo ${this.currentCultivo.metodo}, te dar√© recomendaciones espec√≠ficas.`;
            }

            analyzeCannabiImageWithText(text, image, context) {
                return `Perfecto, he analizado tu imagen junto con tu consulta: "${text}".

**Cultivo analizado:**
${context}

**An√°lisis combinado:**
Bas√°ndome en la imagen y tu descripci√≥n, puedo darte un diagn√≥stico m√°s preciso para tu ${this.currentCultivo.variedad}.

**Recomendaciones espec√≠ficas:**
- Evaluaci√≥n visual confirmada con tu descripci√≥n
- Protocolo de tratamiento adaptado a ${this.currentCultivo.metodo}
- Considerando objetivo terap√©utico: ${this.currentCultivo.objetivo}

**Pr√≥ximos pasos:**
1. Monitoreo diario de la evoluci√≥n
2. Ajustes espec√≠ficos seg√∫n diagn√≥stico
3. Seguimiento fotogr√°fico para comparar progreso

¬øNecesitas el protocolo detallado de tratamiento?`;
            }

            showWelcomeMessage() {
                this.chatHistory.innerHTML = `
                    <div class="message ai-message">
                        <div class="message-content">
                            <strong>Bruce - Especialista en Cannabis Medicinal:</strong> 
                            ¬°Hola! Soy Bruce, tu consultor especializado en cultivo de cannabis medicinal de alta calidad.
                            
                            <br><br><strong>Mi experiencia incluye:</strong>
                            ‚Ä¢ Cultivo medicinal indoor/outdoor/invernadero
                            ‚Ä¢ Optimizaci√≥n de cannabinoides y terpenos
                            ‚Ä¢ Diagn√≥stico y tratamiento de problemas
                            ‚Ä¢ Protocolos de cosecha y curado medicinal
                            ‚Ä¢ Variedades espec√≠ficas para diferentes patolog√≠as
                            
                            <br><br><strong>Para comenzar:</strong>
                            1. Crea un nuevo cultivo con las caracter√≠sticas espec√≠ficas
                            2. Selecciona el cultivo para consultas contextualizadas
                            3. Haz tus preguntas o env√≠a fotos para diagn√≥stico
                            
                            <br>Cada cultivo mantiene su propio historial y contexto profesional.
                        </div>
                    </div>
                `;
            }

            loadCultivoChat() {
                this.chatHistory.innerHTML = '';

                // Mensaje de contexto del cultivo
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.addMessage(`Has seleccionado: **${this.currentCultivo.nombre}**

**Detalles del cultivo:**
‚Ä¢ Variedad: ${this.currentCultivo.variedad}
‚Ä¢ M√©todo: Indoor | Medio: ${medioDisplay[this.currentCultivo.medio] || this.currentCultivo.medio}
‚Ä¢ Setup: ${this.currentCultivo.espacio}m¬≤ | ${this.currentCultivo.plantas || '?'} plantas en macetas de ${this.currentCultivo.macetas || '?'}L
‚Ä¢ Iluminaci√≥n: LED (${this.currentCultivo.potencia || '?'}W)
‚Ä¢ Ventilaci√≥n: Sistema cerrado con CO2
${this.currentCultivo.notas ? `‚Ä¢ Notas: ${this.currentCultivo.notas}` : ''}

Historial de consultas restaurado. ¬øEn qu√© puedo ayudarte con este cultivo?`, 'ai');

                // Cargar historial previo desde la API
                if (this.currentCultivo.chatHistory && this.currentCultivo.chatHistory.length > 0) {
                    this.currentCultivo.chatHistory.forEach(msg => {
                        this.addMessage(msg.content, msg.type, msg.image);
                    });
                }
            }

            togglePanel(panel, open) {
                if (typeof open === 'undefined') {
                    open = !panel.classList.contains('open');
                }
                panel.classList.toggle('open', open);
                if (panel === this.infoPanel) {
                    this.openInfoBtn.style.display = open ? 'none' : 'block';
                } else if (panel === this.notesPanel) {
                    this.openNotesBtn.style.display = open ? 'none' : 'block';
                }
            }

            updateInfoPanel() {
                if (!this.currentCultivo) {
                    this.infoContent.innerHTML = '<p>Selecciona un cultivo para ver la informaci√≥n.</p>';
                    this.notesArea.value = '';
                    return;
                }

                const c = this.currentCultivo;
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.infoContent.innerHTML = `
                    <h3>${c.nombre}</h3>
                    <p><strong>Variedad:</strong> ${c.variedad}</p>
                    <p><strong>M√©todo:</strong> Indoor | Medio: ${medioDisplay[c.medio] || c.medio}</p>
                    <p><strong>Setup:</strong> ${c.espacio}m¬≤ | ${c.plantas || '?'} plantas en macetas de ${c.macetas || '?'}L</p>
                    <p><strong>Iluminaci√≥n:</strong> LED (${c.potencia || '?'}W)</p>
                    <p><strong>Ventilaci√≥n:</strong> Sistema cerrado con CO2</p>
                `;
                this.notesArea.value = c.notas || '';
            }

            async saveNotes() {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            notas: this.notesArea.value
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.currentCultivo.notas = this.notesArea.value;
                        this.addMessage('‚úÖ Notas guardadas exitosamente', 'ai');
                    } else {
                        const error = await response.json();
                        this.addMessage(`‚ùå Error guardando notas: ${error.error}`, 'ai');
                    }
                } catch (error) {
                    console.error('Error guardando notas:', error);
                    this.addMessage('‚ùå Error interno guardando notas', 'ai');
                }
            }

            addMessage(content, sender, image = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                let messageContent = `
                    <div class="message-content">
                        <strong>${sender === 'user' ? 'T√∫' : 'Bruce'}:</strong> 
                `;

                if (image && sender === 'user') {
                    messageContent += `
                        <div class="message-image">
                            <img src="${image}" alt="Imagen enviada" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin: 8px 0;">
                        </div>
                    `;
                }

                if (content) {
                    messageContent += `<span>${content}</span>`;
                }

                messageContent += `
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                messageDiv.innerHTML = messageContent;
                this.chatHistory.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message typing-indicator';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <strong>Bruce:</strong> 
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                `;
                this.chatHistory.appendChild(typingDiv);
                this.scrollToBottom();
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            scrollToBottom() {
                this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            getLightingAdvice() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const wattsPerM2 = potencia / espacio;

                let advice = `Sistema LED de alta calidad para cultivo indoor.`;

                if (wattsPerM2 < 100) {
                    advice += ` Considera aumentar la potencia para mejor rendimiento (actual: ${wattsPerM2.toFixed(0)}W/m¬≤).`;
                } else if (wattsPerM2 > 300) {
                    advice += ` Potencia excelente (${wattsPerM2.toFixed(0)}W/m¬≤), asegurar buena ventilaci√≥n por el calor generado.`;
                } else {
                    advice += ` Potencia adecuada (${wattsPerM2.toFixed(0)}W/m¬≤) para buen desarrollo.`;
                }

                return advice;
            }

            getLightDistance() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                if (potencia <= 300) {
                    return '30-45cm (para LEDs de baja potencia)';
                } else if (potencia <= 600) {
                    return '45-60cm (para LEDs de media potencia)';
                } else {
                    return '60-80cm (para LEDs de alta potencia, ajustar por calor)';
                }
            }

            getAirflowAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const volumen = espacio * 2.5; // Asumiendo 2.5m de altura
                const renovacionPorMinuto = volumen * 1.5; // 1.5 veces por minuto
                return `${renovacionPorMinuto.toFixed(0)} m¬≥/min para tu espacio de ${volumen}m¬≥`;
            }

            getEnvironmentalAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                let advice = 'Sistema cerrado con CO2 √≥ptimo para control de ambiente. ';

                if (potencia > 600) {
                    advice += 'Alta potencia requiere buena renovaci√≥n de aire para controlar temperatura.';
                } else {
                    advice += 'Mant√©n CO2 entre 800-1200ppm para m√°ximo rendimiento.';
                }

                advice += ' Monitoreo constante de temperatura y humedad recomendado.';

                return advice;
            }

            getSpacePerPlant() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const spacePer = (espacio / plantas);
                return `${spacePer.toFixed(2)}m¬≤ por planta`;
            }

            getContainerAdvice() {
                const macetas = parseInt(this.currentCultivo.macetas) || 0;
                const medio = this.currentCultivo.medio;

                let advice = '';

                // Recomendaciones basadas en tama√±o de macetas
                if (macetas < 11) {
                    advice = 'Para buen desarrollo radicular, considerar macetas de 11L o m√°s (actual: ' + macetas + 'L). ';
                } else if (macetas >= 50) {
                    advice = 'Macetas grandes excelentes para desarrollo completo (actual: ' + macetas + 'L). ';
                }

                // Recomendaciones basadas en medio
                if (medio === 'fibra_coco' || medio === 'fibra_coco_perlita') {
                    advice += 'Fibra de coco drena excelente, permite buen control de humedad.';
                } else if (medio === 'light_mix') {
                    advice += 'Light mix retiene nutrientes bien, monitorear pH regularmente.';
                } else if (medio === 'hidro') {
                    advice += 'Sistema hidrop√≥nico requiere recirculaci√≥n constante.';
                }

                return advice;
            }

            getTrainingAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const densidad = espacio / plantas;

                let advice = '';

                if (densidad > 1) {
                    advice = `Espacio generoso (${densidad.toFixed(1)}m¬≤/planta). Ideal para t√©cnicas LST o SCROG para maximizar rendimiento.`;
                } else if (densidad < 0.5) {
                    advice = `Espacio limitado. Considera t√©cnicas SOG o plantas m√°s compactas.`;
                } else {
                    advice = `Densidad equilibrada. Cualquier t√©cnica de entrenamiento funcionar√° bien.`;
                }

                advice += ` Recomiendo LST (Low Stress Training) para principiantes - comenzar en semana 3-4.`;

                return advice;
            }

            getSpaceOptimizationTips() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;

                if (espacio / plantas > 1) {
                    return 'Espacio generoso, ideal para t√©cnicas LST/SCROG.';
                } else if (espacio / plantas < 0.5) {
                    return 'Espacio limitado, considera SOG o plantas m√°s peque√±as.';
                } else {
                    return 'Densidad equilibrada, cualquier t√©cnica funcionar√° bien.';
                }
            }
        }

        // Inicializar Bruce AI cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar men√∫ hamburguesa para m√≥viles
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');

            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navToggle.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });

                // Cerrar men√∫ cuando se hace click en un enlace
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    });
                });

                // Cerrar men√∫ cuando se hace click fuera de √©l
                document.addEventListener('click', function(e) {
                    if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    }
                });
            }

            new BruceAI();
        });
    </script>
</body>

</html>