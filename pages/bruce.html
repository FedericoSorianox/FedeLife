<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>🌱 Bruce - Experto Cannabis Medicinal</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌱</text></svg>">
    <link rel="stylesheet" href="app.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Navegación moderna y minimalista -->
    <nav class="modern-navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <span class="brand-icon">🌱</span>
                <span class="brand-text">Fede Life</span>
            </div>
            
            <div class="nav-actions">
                <!-- Estado de autenticación compacto -->
                <div id="auth-status" class="auth-status-compact">
                    <div id="userInfo" class="user-info-compact" style="display: none;">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="userName" class="user-name"></span>
                        <button id="logoutBtn" class="logout-btn-compact">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <div id="authButton" class="auth-button-compact" style="display: none;">
                        <button onclick="window.location.href='login.html'" class="login-btn-compact">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Login</span>
                        </button>
                    </div>
                    <div id="autoAuthButton" class="auto-auth-button-compact" style="display: none;">
                        <button onclick="tryAutoLogin()" class="auto-login-btn-compact">
                            <i class="fas fa-magic"></i>
                            <span>Auto Login</span>
                        </button>
                    </div>
                </div>

                <!-- Menú hamburguesa moderno -->
                <button class="menu-toggle" id="navToggle" aria-label="Menu">
                    <div class="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Menú lateral moderno -->
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header">
                <h3>Navegación</h3>
                <button class="close-menu" id="closeMenu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="side-menu-nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="finanzas.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Finanzas</span>
                </a>
                <a href="tareas.html" class="nav-link">
                    <i class="fas fa-tasks"></i>
                    <span>Tareas</span>
                </a>
                <a href="bruce.html" class="nav-link active">
                    <i class="fas fa-seedling"></i>
                    <span>Bruce - Cannabis</span>
                </a>
            </nav>
        </div>
    </nav>

    <!-- Overlay para el menú -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <!-- Contenido principal -->
    <main class="main-container">
        <!-- Header del chat moderno -->
        <header class="chat-header-modern">
            <div class="header-content">
                <div class="expert-info">
                    <div class="expert-avatar">
                        <div class="avatar-icon">🧠</div>
                        <div class="status-indicator active"></div>
                    </div>
                    <div class="expert-details">
                        <h1 class="expert-name">Dr. Bruce Bugbee</h1>
                        <p class="expert-title">Especialista Cannabis Medicinal</p>
                        <div class="expert-status">
                            <i class="fas fa-circle online"></i>
                            <span>En línea</span>
                        </div>
                    </div>
                </div>
                
                <!-- Selector de cultivo mejorado -->
                <div class="cultivo-selector-modern" id="cultivoSelectorContainer">
                    <!-- Se insertará dinámicamente -->
                </div>
            </div>
        </header>

        <!-- Área del chat rediseñada -->
        <section class="chat-container-modern">
            <div class="chat-messages" id="chat-history">
                <!-- Los mensajes se cargarán aquí -->
            </div>

            <!-- Input moderno y elegante -->
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <!-- Área de texto principal -->
                    <div class="text-input-area">
                        <textarea 
                            id="user-input" 
                            placeholder="Pregúntale a Bruce sobre tu cultivo..." 
                            rows="1"
                            maxlength="2000"></textarea>
                        <div class="char-counter">
                            <span id="charCount">0</span>/2000
                        </div>
                    </div>

                    <!-- Vista previa de imagen -->
                    <div class="image-preview-modern" id="image-preview" style="display: none;">
                        <div class="preview-container">
                            <img id="preview-img" src="" alt="Vista previa">
                            <button id="remove-image" class="remove-image-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Controles del input -->
                    <div class="input-controls">
                        <div class="left-controls">
                            <button id="attach-image" class="control-btn attach-btn" title="Adjuntar imagen">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="image-input" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="right-controls">
                            <button id="send-message" class="send-btn-modern" disabled>
                                <i class="fas fa-paper-plane"></i>
                                <span>Enviar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sugerencias rápidas -->
                <div class="quick-suggestions" id="quickSuggestions">
                    <div class="suggestion-item" data-text="¿Cómo está mi cultivo?">
                        <i class="fas fa-seedling"></i>
                        <span>Estado del cultivo</span>
                    </div>
                    <div class="suggestion-item" data-text="¿Qué nutrientes necesito?">
                        <i class="fas fa-tint"></i>
                        <span>Nutrientes</span>
                    </div>
                    <div class="suggestion-item" data-text="¿Cuándo cosechar?">
                        <i class="fas fa-cut"></i>
                        <span>Cosecha</span>
                    </div>
                    <div class="suggestion-item" data-text="Analizar esta imagen">
                        <i class="fas fa-search"></i>
                        <span>Analizar imagen</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Botones flotantes modernos -->
    <div class="floating-actions">
        <button id="open-info" class="fab fab-info" title="Información del cultivo">
            <i class="fas fa-info-circle"></i>
        </button>
        <button id="open-notes" class="fab fab-notes" title="Notas del cultivo">
            <i class="fas fa-sticky-note"></i>
        </button>
    </div>

    <!-- Panel lateral izquierdo moderno: información del cultivo -->
    <div id="cultivo-info" class="side-panel left">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-info-circle"></i>
                <h3>Información del Cultivo</h3>
            </div>
            <button class="panel-close" data-target="cultivo-info">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-body" id="cultivo-info-content">
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <h4>Sin cultivo seleccionado</h4>
                <p>Selecciona o crea un cultivo para ver la información detallada</p>
            </div>
        </div>
    </div>

    <!-- Panel lateral derecho moderno: notas del cultivo -->
    <div id="cultivo-notes" class="side-panel right">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-sticky-note"></i>
                <h3>Notas del Cultivo</h3>
            </div>
            <button class="panel-close" data-target="cultivo-notes">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-body">
            <div class="notes-container">
                <div class="notes-input-area">
                    <textarea 
                        id="notes-area" 
                        placeholder="Escribe tus observaciones del cultivo..."
                        rows="4"></textarea>
                    <div class="notes-actions">
                        <button id="save-notes" class="save-notes-btn">
                            <i class="fas fa-save"></i>
                            <span>Guardar Nota</span>
                        </button>
                    </div>
                </div>
                <div class="notes-history" id="notesHistory">
                    <!-- Las notas se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay para paneles -->
    <div class="panels-overlay" id="panelsOverlay"></div>

    <!-- Footer minimalista -->
    <footer class="modern-footer">
        <div class="footer-content">
            <span>© 2024 Fede Life - Cultivo Cannabis Medicinal</span>
        </div>
    </footer>

    <!-- Estilos CSS modernos y responsivos -->
    <style>
        /* Reset y fuentes */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colores principales */
            --primary-green: #2E7D32;
            --secondary-green: #4CAF50;
            --light-green: #81C784;
            --dark-green: #1B5E20;
            --accent-green: #66BB6A;
            
            /* Colores de fondo */
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F5;
            --bg-dark: #263238;
            
            /* Colores de texto */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-white: #FFFFFF;
            --text-muted: #9E9E9E;
            
            /* Sombras */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
            
            /* Bordes redondeados */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Espaciado */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F1F8E9 0%, #E8F5E8 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Navegación moderna */
        .modern-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 0 var(--spacing-md);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 64px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            color: var(--primary-green);
        }

        .brand-icon {
            font-size: 24px;
        }

        .brand-text {
            font-size: 18px;
            font-weight: 700;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        /* Menú hamburguesa moderno */
        .menu-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }

        .menu-toggle:hover {
            background: rgba(46, 125, 50, 0.1);
        }

        .hamburger {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .hamburger span {
            width: 20px;
            height: 2px;
            background: var(--primary-green);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .menu-toggle.active .hamburger span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .menu-toggle.active .hamburger span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active .hamburger span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Menú lateral */
        .side-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            overflow-y: auto;
        }

        .side-menu.active {
            transform: translateX(-320px);
        }

        .side-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: var(--primary-green);
            color: var(--text-white);
        }

        .side-menu-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-menu {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--text-white);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-menu:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .side-menu-nav {
            padding: var(--spacing-lg);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
            margin-bottom: var(--spacing-sm);
        }

        .nav-link:hover {
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary-green);
        }

        .nav-link.active {
            background: var(--primary-green);
            color: var(--text-white);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Overlay del menú */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1050;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Autenticación compacta */
        .auth-status-compact {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .user-info-compact {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(46, 125, 50, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            background: var(--primary-green);
            color: var(--text-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-green);
        }

        .logout-btn-compact, .login-btn-compact, .auto-login-btn-compact {
            background: var(--primary-green);
            color: var(--text-white);
            border: none;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn-compact:hover, .login-btn-compact:hover, .auto-login-btn-compact:hover {
            background: var(--dark-green);
            transform: translateY(-1px);
        }

        /* Contenedor principal */
        .main-container {
            margin-top: 64px;
            min-height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
        }

        /* Header del chat moderno */
        .chat-header-modern {
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .expert-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .expert-avatar {
            position: relative;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
        }

        .avatar-icon {
            font-size: 24px;
            color: var(--text-white);
        }

        .status-indicator {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border: 2px solid var(--bg-secondary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .expert-details h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .expert-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .expert-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 12px;
            color: var(--secondary-green);
        }

        .expert-status .online {
            font-size: 8px;
            animation: pulse 2s infinite;
        }

        /* Selector de cultivo moderno */
        .cultivo-selector-modern {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Contenedor del chat */
        .chat-container-modern {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 0 var(--spacing-md);
        }

        /* Mensajes del chat */
        .chat-messages {
            flex: 1;
            padding: var(--spacing-lg) 0;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Input del chat moderno */
        .chat-input-container {
            background: var(--bg-secondary);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--spacing-lg);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        .input-wrapper {
            background: var(--bg-tertiary);
            border-radius: var(--radius-xl);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .text-input-area {
            position: relative;
            padding: var(--spacing-md);
        }

        #user-input {
            width: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            outline: none;
            min-height: 24px;
            max-height: 120px;
        }

        #user-input::placeholder {
            color: var(--text-muted);
        }

        .char-counter {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 11px;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Vista previa de imagen moderna */
        .image-preview-modern {
            padding: var(--spacing-md);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .preview-container {
            position: relative;
            display: inline-block;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .preview-container img {
            max-width: 200px;
            max-height: 150px;
            display: block;
        }

        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .remove-image-btn:hover {
            background: #f44336;
        }

        /* Controles del input */
        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .left-controls, .right-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary-green);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--primary-green);
            color: var(--text-white);
            transform: scale(1.05);
        }

        .send-btn-modern {
            background: var(--primary-green);
            color: var(--text-white);
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .send-btn-modern:hover:not(:disabled) {
            background: var(--dark-green);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .send-btn-modern:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        /* Sugerencias rápidas */
        .quick-suggestions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid rgba(46, 125, 50, 0.2);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 13px;
            color: var(--primary-green);
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            background: var(--primary-green);
            color: var(--text-white);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .suggestion-item i {
            font-size: 12px;
        }

        /* Botones flotantes */
        .floating-actions {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            z-index: 100;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fab-info {
            background: var(--primary-green);
            color: var(--text-white);
        }

        .fab-notes {
            background: #FF9800;
            color: var(--text-white);
        }

        .fab:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Paneles laterales modernos */
        .side-panel {
            position: fixed;
            top: 64px;
            width: 400px;
            height: calc(100vh - 64px);
            background: var(--bg-secondary);
            box-shadow: var(--shadow-lg);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }

        .side-panel.right {
            right: 0;
            transform: translateX(100%);
        }

        .side-panel.active {
            transform: translateX(0);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: var(--bg-tertiary);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .panel-title h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-title i {
            color: var(--primary-green);
        }

        .panel-close {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .panel-close:hover {
            background: #f44336;
            color: var(--text-white);
        }

        .panel-body {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        /* Estado vacío */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-lg);
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: var(--spacing-md);
        }

        .empty-state h4 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        /* Área de notas */
        .notes-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .notes-input-area {
            margin-bottom: var(--spacing-lg);
        }

        .notes-input-area textarea {
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }

        .notes-input-area textarea:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .notes-actions {
            margin-top: var(--spacing-md);
        }

        .save-notes-btn {
            background: var(--primary-green);
            color: var(--text-white);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .save-notes-btn:hover {
            background: var(--dark-green);
            transform: translateY(-1px);
        }

        /* Overlay para paneles */
        .panels-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 150;
        }

        .panels-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Footer moderno */
        .modern-footer {
            background: var(--bg-secondary);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--spacing-md);
            text-align: center;
        }

        .footer-content {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Estilos para mensajes del chat */
        .message {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            max-width: 80%;
            animation: fadeInUp 0.4s ease-out;
            box-shadow: var(--shadow-sm);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--text-white);
            margin-left: auto;
            border-bottom-right-radius: var(--radius-sm);
        }

        .ai-message {
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-content {
            line-height: 1.6;
            font-size: 15px;
        }

        .message-content strong {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            font-size: 16px;
        }

        .user-message .message-content strong {
            color: rgba(255, 255, 255, 0.9);
        }

        .ai-message .message-content strong {
            color: var(--primary-green);
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            margin: var(--spacing-md) 0;
            max-width: 200px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary-green);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        /* Responsive Design para iPhone 16 y móviles */
        @media (max-width: 768px) {
            .nav-content {
                padding: 0 var(--spacing-md);
            }

            .brand-text {
                display: none;
            }

            .header-content {
                flex-direction: column;
                gap: var(--spacing-md);
                align-items: flex-start;
            }

            .expert-info {
                align-self: stretch;
            }

            .cultivo-selector-modern {
                align-self: stretch;
            }

            .chat-container-modern {
                padding: 0 var(--spacing-sm);
            }

            .chat-messages {
                padding: var(--spacing-md) 0;
            }

            .message {
                max-width: 90%;
                padding: var(--spacing-md);
            }

            .quick-suggestions {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: var(--spacing-sm);
            }

            .suggestion-item {
                flex-shrink: 0;
            }

            .side-panel {
                width: 100vw;
                max-width: 400px;
            }

            .floating-actions {
                bottom: 16px;
                right: 16px;
            }

            .fab {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            /* Ajustes específicos para iPhone */
            .chat-input-container {
                padding-bottom: env(safe-area-inset-bottom, var(--spacing-lg));
            }

            .main-container {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* Estilos para iPhone 16 específicamente */
        @media (max-width: 430px) and (min-height: 800px) {
            .modern-navbar {
                padding-left: env(safe-area-inset-left, var(--spacing-md));
                padding-right: env(safe-area-inset-right, var(--spacing-md));
            }

            .expert-avatar {
                width: 50px;
                height: 50px;
            }

            .avatar-icon {
                font-size: 20px;
            }

            .expert-details h1 {
                font-size: 18px;
            }

            .expert-title {
                font-size: 13px;
            }

            #user-input {
                font-size: 16px; /* Previene zoom en iOS */
            }

            .chat-input-container {
                padding-left: env(safe-area-inset-left, var(--spacing-lg));
                padding-right: env(safe-area-inset-right, var(--spacing-lg));
            }
        }

        /* Dark mode ready */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #121212;
                --bg-secondary: #1E1E1E;
                --bg-tertiary: #2D2D2D;
                --text-primary: #FFFFFF;
                --text-secondary: #B3B3B3;
                --text-muted: #666666;
            }
        }

        /* Animaciones mejoradas */
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .user-message {
            animation: slideInFromRight 0.4s ease-out;
        }

        .ai-message {
            animation: slideInFromLeft 0.4s ease-out;
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-green);
        }

        /* Estados de focus mejorados */
        button:focus-visible, 
        input:focus-visible, 
        textarea:focus-visible {
            outline: 2px solid var(--primary-green);
            outline-offset: 2px;
        }

        /* Mejoras de performance */
        .chat-messages {
            contain: layout style paint;
        }

        .message {
            contain: layout style;
        }

        /* Efectos especiales para interacciones */
        .send-btn-modern:active {
            transform: scale(0.95);
        }

        .fab:active {
            transform: scale(0.9);
        }

        .suggestion-item:active {
            transform: scale(0.95);
        }
    </style>

    <script src="auth.js"></script>
    <script src="../funciones/cannabis_chat.js"></script>
    <script>
        class BruceAI {
            constructor() {
                // Referencias de elementos del chat
                this.chatHistory = document.getElementById('chat-history');
                this.userInput = document.getElementById('user-input');
                this.imageInput = document.getElementById('image-input');
                this.imagePreview = document.getElementById('image-preview');
                this.previewImg = document.getElementById('preview-img');
                this.sendButton = document.getElementById('send-message');
                this.attachButton = document.getElementById('attach-image');
                this.removeImageButton = document.getElementById('remove-image');

                // Referencias de navegación moderna
                this.navToggle = document.getElementById('navToggle');
                this.sideMenu = document.getElementById('sideMenu');
                this.menuOverlay = document.getElementById('menuOverlay');
                this.closeMenu = document.getElementById('closeMenu');

                // Referencias de paneles laterales modernos
                this.infoPanel = document.getElementById('cultivo-info');
                this.notesPanel = document.getElementById('cultivo-notes');
                this.openInfoBtn = document.getElementById('open-info');
                this.openNotesBtn = document.getElementById('open-notes');
                this.notesArea = document.getElementById('notes-area');
                this.saveNotesBtn = document.getElementById('save-notes');
                this.infoContent = document.getElementById('cultivo-info-content');
                this.panelsOverlay = document.getElementById('panelsOverlay');

                // Referencias adicionales para UI moderna
                this.charCount = document.getElementById('charCount');
                this.quickSuggestions = document.getElementById('quickSuggestions');
                this.cultivoSelectorContainer = document.getElementById('cultivoSelectorContainer');

                this.currentImage = null;
                this.currentCultivo = null;
                this.cultivos = {};

                // Inicializar chat de cannabis medicinal
                this.cannabisChat = window.cannabisChat || null;
                if (this.cannabisChat) {
                    console.log('✅ Chat de cannabis medicinal cargado exitosamente');
                } else {
                    console.warn('⚠️ Chat de cannabis medicinal no encontrado, se inicializará cuando esté disponible');
                }

                // Esperar a que la autenticación esté lista antes de inicializar
                this.waitForAuth().then(() => {
                    this.initializeEventListeners();
                    this.loadCultivos().then(() => {
                        this.initializeCultivoSelector();
                        this.updateCultivoDropdown();
                        this.showWelcomeMessage();
                        this.updateInfoPanel();
                    });
                });
            }


            initializeEventListeners() {
                // Eventos del chat
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                // Input con auto-resize y contador de caracteres
                this.userInput.addEventListener('input', (e) => {
                    this.updateCharCounter();
                    this.autoResizeInput();
                    this.updateSendButtonState();
                });

                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Botones de adjuntar y remover imagen
                this.attachButton.addEventListener('click', () => {
                    this.imageInput.click();
                });

                this.imageInput.addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                this.removeImageButton.addEventListener('click', () => {
                    this.removeImage();
                });

                // Navegación moderna
                this.setupModernNavigation();

                // Paneles laterales modernos
                this.setupModernPanels();

                // Sugerencias rápidas
                this.setupQuickSuggestions();

                // Eventos adicionales
                this.saveNotesBtn.addEventListener('click', () => this.saveNotes());

                // Gestos táctiles para móvil
                this.setupTouchGestures();
            }

            setupModernNavigation() {
                // Toggle del menú principal
                this.navToggle.addEventListener('click', () => {
                    this.toggleSideMenu();
                });

                // Cerrar menú
                this.closeMenu.addEventListener('click', () => {
                    this.closeSideMenu();
                });

                // Overlay para cerrar menú
                this.menuOverlay.addEventListener('click', () => {
                    this.closeSideMenu();
                });

                // Cerrar menú al hacer clic en un enlace
                const navLinks = this.sideMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        this.closeSideMenu();
                    });
                });
            }

            setupModernPanels() {
                // Botones FAB para abrir paneles
                this.openInfoBtn.addEventListener('click', () => this.togglePanel('info', true));
                this.openNotesBtn.addEventListener('click', () => this.togglePanel('notes', true));

                // Botones de cerrar paneles
                const infoPanelClose = this.infoPanel.querySelector('.panel-close');
                const notesPanelClose = this.notesPanel.querySelector('.panel-close');

                if (infoPanelClose) {
                    infoPanelClose.addEventListener('click', () => this.togglePanel('info', false));
                }

                if (notesPanelClose) {
                    notesPanelClose.addEventListener('click', () => this.togglePanel('notes', false));
                }

                // Overlay para cerrar paneles
                this.panelsOverlay.addEventListener('click', () => {
                    this.closeAllPanels();
                });
            }

            setupQuickSuggestions() {
                const suggestions = this.quickSuggestions.querySelectorAll('.suggestion-item');
                suggestions.forEach(suggestion => {
                    suggestion.addEventListener('click', () => {
                        const text = suggestion.dataset.text;
                        this.userInput.value = text;
                        this.updateCharCounter();
                        this.updateSendButtonState();
                        this.userInput.focus();
                        
                        // Auto-enviar para ciertas sugerencias
                        if (text === "Analizar esta imagen" && this.currentImage) {
                            this.sendMessage();
                        }
                    });
                });
            }

            setupTouchGestures() {
                // Swipe para abrir/cerrar paneles en móvil
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                const handleTouchStart = (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                };

                const handleTouchMove = (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                };

                const handleTouchEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;

                    const deltaX = currentX - startX;
                    const threshold = 50;

                    // Swipe desde el borde izquierdo para abrir info
                    if (startX < 20 && deltaX > threshold) {
                        this.togglePanel('info', true);
                    }
                    // Swipe desde el borde derecho para abrir notas
                    else if (startX > window.innerWidth - 20 && deltaX < -threshold) {
                        this.togglePanel('notes', true);
                    }
                };

                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
            }

            // Métodos auxiliares para la UI moderna
            updateCharCounter() {
                const currentLength = this.userInput.value.length;
                const maxLength = 2000;
                this.charCount.textContent = currentLength;
                
                // Cambiar color si se acerca al límite
                if (currentLength > maxLength * 0.9) {
                    this.charCount.style.color = '#f44336';
                } else if (currentLength > maxLength * 0.7) {
                    this.charCount.style.color = '#ff9800';
                } else {
                    this.charCount.style.color = 'var(--text-muted)';
                }
            }

            autoResizeInput() {
                this.userInput.style.height = 'auto';
                this.userInput.style.height = Math.min(this.userInput.scrollHeight, 120) + 'px';
            }

            updateSendButtonState() {
                const hasText = this.userInput.value.trim().length > 0;
                const hasImage = this.currentImage !== null;
                this.sendButton.disabled = !hasText && !hasImage;
            }

            toggleSideMenu() {
                this.sideMenu.classList.toggle('active');
                this.menuOverlay.classList.toggle('active');
                this.navToggle.classList.toggle('active');
                
                // Prevenir scroll del body cuando el menú está abierto
                document.body.style.overflow = this.sideMenu.classList.contains('active') ? 'hidden' : '';
            }

            closeSideMenu() {
                this.sideMenu.classList.remove('active');
                this.menuOverlay.classList.remove('active');
                this.navToggle.classList.remove('active');
                document.body.style.overflow = '';
            }

            togglePanel(panelType, open) {
                const panel = panelType === 'info' ? this.infoPanel : this.notesPanel;
                const isOpen = panel.classList.contains('active');
                
                if (open === undefined) {
                    open = !isOpen;
                }

                if (open) {
                    // Cerrar otros paneles primero
                    this.closeAllPanels();
                    
                    panel.classList.add('active');
                    this.panelsOverlay.classList.add('active');
                    
                    // Cargar datos específicos del panel
                    if (panelType === 'notes' && this.currentCultivo) {
                        this.loadNotasFromAPI();
                    }
                } else {
                    panel.classList.remove('active');
                    this.checkPanelsOverlay();
                }
            }

            closeAllPanels() {
                this.infoPanel.classList.remove('active');
                this.notesPanel.classList.remove('active');
                this.panelsOverlay.classList.remove('active');
            }

            checkPanelsOverlay() {
                const anyPanelOpen = this.infoPanel.classList.contains('active') || 
                                   this.notesPanel.classList.contains('active');
                
                if (!anyPanelOpen) {
                    this.panelsOverlay.classList.remove('active');
                }
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>Bruce está escribiendo...</span>
                `;
                this.chatHistory.appendChild(typingDiv);
                this.scrollToBottom();
            }

            // Gestión de cultivos con API
            async loadCultivos() {
                try {
                    const response = await fetch('/api/cultivos', {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.cultivos = {};
                        result.data.forEach(cultivo => {
                            this.cultivos[cultivo.id] = cultivo;
                        });
                        return this.cultivos;
                    } else {
                        console.error('Error cargando cultivos:', response.status);
                        return {};
                    }
                } catch (error) {
                    console.error('Error cargando cultivos:', error);
                    return {};
                }
            }

            getAuthToken() {
                // Obtener token de autenticación del sistema de auth.js
                // Primero buscar en dev_auth_token (para desarrollo)
                let token = localStorage.getItem('dev_auth_token');

                // Si no está, buscar en auth_data
                if (!token) {
                    const authData = localStorage.getItem('auth_data');
                    if (authData) {
                        try {
                            const parsed = JSON.parse(authData);
                            token = parsed.token;
                        } catch (error) {
                            console.error('Error parseando auth_data:', error);
                        }
                    }
                }

                // Si aún no hay token, buscar en authToken (compatibilidad)
                if (!token) {
                    token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                }

                return token || '';
            }

            getApiBaseUrl() {
                // Usar la misma lógica que auth.js
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return 'http://localhost:3000/api';
                }
                return `${window.location.protocol}//${window.location.host}/api`;
            }

            async waitForAuth() {
                return new Promise((resolve) => {
                    // Verificar si ya hay un token disponible
                    if (this.getAuthToken()) {
                        resolve();
                        return;
                    }

                    // Si no hay token, esperar a que se complete la autenticación automática
                    const checkAuth = () => {
                        if (this.getAuthToken()) {
                            resolve();
                        } else {
                            // Esperar un poco y verificar nuevamente
                            setTimeout(checkAuth, 500);
                        }
                    };

                    // Timeout después de 10 segundos para evitar esperar indefinidamente
                    setTimeout(() => {
                        console.warn('Timeout esperando autenticación, continuando sin token');
                        resolve();
                    }, 10000);

                    checkAuth();
                });
            }

            initializeCultivoSelector() {
                // Insertar en el contenedor moderno del header
                this.cultivoSelectorContainer.innerHTML = `
                    <div class="cultivo-controls-modern">
                        <div class="cultivo-select-wrapper">
                            <i class="fas fa-seedling"></i>
                            <select id="cultivo-select" class="cultivo-dropdown-modern">
                                <option value="">Seleccionar cultivo...</option>
                            </select>
                        </div>
                        <div class="cultivo-actions">
                            <button id="new-cultivo-btn" class="cultivo-btn new-btn" title="Nuevo cultivo">
                                <i class="fas fa-plus"></i>
                                <span>Nuevo</span>
                            </button>
                            <button id="edit-cultivo-btn" class="cultivo-btn edit-btn" style="display: none;" title="Editar cultivo">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button id="delete-cultivo-btn" class="cultivo-btn delete-btn" style="display: none;" title="Eliminar cultivo">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        .cultivo-controls-modern {
                            display: flex;
                            gap: var(--spacing-md);
                            align-items: center;
                            flex-wrap: wrap;
                        }
                        
                        .cultivo-select-wrapper {
                            display: flex;
                            align-items: center;
                            gap: var(--spacing-sm);
                            background: var(--bg-secondary);
                            border: 1px solid rgba(0, 0, 0, 0.2);
                            border-radius: var(--radius-md);
                            padding: var(--spacing-sm) var(--spacing-md);
                            min-width: 200px;
                        }
                        
                        .cultivo-select-wrapper i {
                            color: var(--primary-green);
                            font-size: 14px;
                        }
                        
                        .cultivo-dropdown-modern {
                            border: none;
                            background: transparent;
                            outline: none;
                            font-family: inherit;
                            font-size: 14px;
                            color: var(--text-primary);
                            flex: 1;
                            cursor: pointer;
                        }
                        
                        .cultivo-actions {
                            display: flex;
                            gap: var(--spacing-sm);
                            align-items: center;
                        }
                        
                        .cultivo-btn {
                            display: flex;
                            align-items: center;
                            gap: var(--spacing-xs);
                            padding: var(--spacing-sm) var(--spacing-md);
                            border: none;
                            border-radius: var(--radius-md);
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        }
                        
                        .new-btn {
                            background: var(--primary-green);
                            color: var(--text-white);
                        }
                        
                        .new-btn:hover {
                            background: var(--dark-green);
                            transform: translateY(-1px);
                        }
                        
                        .edit-btn {
                            background: #2196F3;
                            color: var(--text-white);
                            width: 36px;
                            height: 36px;
                            padding: 0;
                            justify-content: center;
                        }
                        
                        .edit-btn:hover {
                            background: #1976D2;
                            transform: translateY(-1px);
                        }
                        
                        .delete-btn {
                            background: #f44336;
                            color: var(--text-white);
                            width: 36px;
                            height: 36px;
                            padding: 0;
                            justify-content: center;
                        }
                        
                        .delete-btn:hover {
                            background: #d32f2f;
                            transform: translateY(-1px);
                        }
                        
                        @media (max-width: 768px) {
                            .cultivo-controls-modern {
                                flex-direction: column;
                                align-items: stretch;
                                gap: var(--spacing-sm);
                            }
                            
                            .cultivo-select-wrapper {
                                min-width: auto;
                            }
                            
                            .cultivo-actions {
                                justify-content: center;
                            }
                            
                            .cultivo-btn span {
                                display: none;
                            }
                        }
                    </style>
                `;

                this.cultivoSelect = document.getElementById('cultivo-select');
                this.newCultivoBtn = document.getElementById('new-cultivo-btn');
                this.editCultivoBtn = document.getElementById('edit-cultivo-btn');
                this.deleteCultivoBtn = document.getElementById('delete-cultivo-btn');

                this.cultivoSelect.addEventListener('change', (e) => this.selectCultivo(e.target.value));
                this.newCultivoBtn.addEventListener('click', () => this.createNewCultivo());
                this.editCultivoBtn.addEventListener('click', () => this.editCultivo());
                this.deleteCultivoBtn.addEventListener('click', () => this.deleteCultivo());

                this.updateCultivoDropdown();
            }

            updateCultivoDropdown() {
                const select = this.cultivoSelect;
                select.innerHTML = '<option value="">Seleccionar cultivo...</option>';

                Object.keys(this.cultivos).forEach(id => {
                    const cultivo = this.cultivos[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${cultivo.nombre} (${cultivo.variedad})`;
                    select.appendChild(option);
                });
            }

            async selectCultivo(cultivoId) {
                if (cultivoId) {
                    // Si no tenemos el cultivo en memoria, cargarlo desde la API
                    if (!this.cultivos[cultivoId]) {
                        try {
                            const response = await fetch(`/api/cultivos/${cultivoId}`, {
                                headers: {
                                    'Authorization': `Bearer ${this.getAuthToken()}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                const result = await response.json();
                                this.cultivos[cultivoId] = result.data;
                            } else {
                                console.error('Error cargando cultivo específico:', response.status);
                                return;
                            }
                        } catch (error) {
                            console.error('Error cargando cultivo específico:', error);
                            return;
                        }
                    }

                    this.currentCultivo = this.cultivos[cultivoId];
                    this.editCultivoBtn.style.display = 'inline-block';
                    this.deleteCultivoBtn.style.display = 'inline-block';

                    // Actualizar contexto del chat de cannabis
                    if (this.cannabisChat) {
                        this.cannabisChat.setCurrentCultivo(this.currentCultivo);
                        await this.loadCultivoNotes(); // Cargar notas para el contexto
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCurrentCultivo(this.currentCultivo);
                        await this.loadCultivoNotes();
                    }

                    this.loadCultivoChat();
                    this.updateInfoPanel();

                    // Expandir automáticamente los paneles laterales cuando se selecciona un cultivo
                    this.togglePanel(this.infoPanel, true);
                    this.togglePanel(this.notesPanel, true);
                } else {
                    this.currentCultivo = null;
                    this.editCultivoBtn.style.display = 'none';
                    this.deleteCultivoBtn.style.display = 'none';

                    // Limpiar contexto del chat
                    if (this.cannabisChat) {
                        this.cannabisChat.setCurrentCultivo(null);
                        this.cannabisChat.setCultivoNotes([]);
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCurrentCultivo(null);
                        this.cannabisChat.setCultivoNotes([]);
                    }

                    this.showWelcomeMessage();
                    this.updateInfoPanel();

                    // Cerrar paneles laterales cuando no hay cultivo seleccionado
                    this.togglePanel(this.infoPanel, false);
                    this.togglePanel(this.notesPanel, false);
                }
            }

            async createNewCultivo() {
                const cultivoData = await this.promptCultivoData();
                if (cultivoData) {
                    try {
                        const response = await fetch('/api/cultivos', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[cultivo.id] = cultivo;
                            this.updateCultivoDropdown();
                            this.cultivoSelect.value = cultivo.id;
                            this.selectCultivo(cultivo.id);
                            this.addMessage('✅ Cultivo creado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`❌ Error creando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error creando cultivo:', error);
                        this.addMessage('❌ Error interno creando cultivo', 'ai');
                    }
                }
            }

            async editCultivo() {
                if (!this.currentCultivo) return;

                const cultivoData = await this.promptCultivoData(this.currentCultivo);
                if (cultivoData) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cultivoData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const cultivo = result.data;
                            this.cultivos[this.currentCultivo.id] = cultivo;
                            this.currentCultivo = cultivo;
                            this.updateCultivoDropdown();
                            this.loadCultivoChat();
                            this.updateInfoPanel();
                            this.addMessage('✅ Cultivo actualizado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`❌ Error actualizando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error actualizando cultivo:', error);
                        this.addMessage('❌ Error interno actualizando cultivo', 'ai');
                    }
                }
            }

            async deleteCultivo() {
                if (!this.currentCultivo) return;

                if (confirm(`¿Estás seguro de eliminar el cultivo "${this.currentCultivo.nombre}"?`)) {
                    try {
                        const response = await fetch(`/api/cultivos/${this.currentCultivo.id}?archive=true`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            delete this.cultivos[this.currentCultivo.id];
                            this.updateCultivoDropdown();
                            this.currentCultivo = null;
                            this.editCultivoBtn.style.display = 'none';
                            this.deleteCultivoBtn.style.display = 'none';
                            this.showWelcomeMessage();
                            this.updateInfoPanel();
                            this.addMessage('✅ Cultivo archivado exitosamente', 'ai');
                        } else {
                            const error = await response.json();
                            this.addMessage(`❌ Error eliminando cultivo: ${error.error}`, 'ai');
                        }
                    } catch (error) {
                        console.error('Error eliminando cultivo:', error);
                        this.addMessage('❌ Error interno eliminando cultivo', 'ai');
                    }
                }
            }

            async promptCultivoData(existingData = {}) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'cultivo-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>${existingData.id ? 'Editar' : 'Nuevo'} Cultivo de Cannabis Medicinal</h3>
                            <form id="cultivo-form">
                                <div class="form-group">
                                    <label>Nombre del cultivo:</label>
                                    <input type="text" id="nombre" value="${existingData.nombre || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Variedad/Cepa:</label>
                                    <input type="text" id="variedad" value="${existingData.variedad || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Medio de cultivo:</label>
                                    <select id="medio" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="fibra_coco" ${existingData.medio === 'fibra_coco' ? 'selected' : ''}>Fibra de coco</option>
                                        <option value="fibra_coco_perlita" ${existingData.medio === 'fibra_coco_perlita' ? 'selected' : ''}>Fibra de coco + perlita</option>
                                        <option value="light_mix" ${existingData.medio === 'light_mix' ? 'selected' : ''}>Light mix</option>
                                        <option value="hidro" ${existingData.medio === 'hidro' ? 'selected' : ''}>Hidro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Espacio de cultivo (m²):</label>
                                    <input type="number" id="espacio" value="${existingData.espacio || ''}" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label>Tamaño de macetas (L):</label>
                                    <input type="number" id="macetas" value="${existingData.macetas || ''}" step="1" placeholder="ej: 11, 20, 50..." required>
                                </div>
                                <div class="form-group">
                                    <label>Potencia lumínica (W):</label>
                                    <input type="number" id="potencia" value="${existingData.potencia || ''}" placeholder="ej: 240, 600, 1000..." required>
                                </div>
                                <div class="form-group">
                                    <label>Número de plantas:</label>
                                    <input type="number" id="plantas" value="${existingData.plantas || ''}" min="1" placeholder="ej: 1, 4, 9..." required>
                                </div>
                                <div class="form-group">
                                    <label>Notas adicionales:</label>
                                    <textarea id="notas" rows="3" placeholder="Detalles específicos, objetivos, observaciones...">${existingData.notas || ''}</textarea>
                                </div>
                                <div class="form-buttons">
                                    <button type="submit">${existingData.id ? 'Actualizar' : 'Crear'} Cultivo</button>
                                    <button type="button" onclick="this.closest('.cultivo-modal').remove()">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    document.getElementById('cultivo-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const cultivoData = {
                            nombre: formData.get('nombre') || document.getElementById('nombre').value,
                            variedad: formData.get('variedad') || document.getElementById('variedad').value,
                            metodo: 'indoor', // Siempre indoor
                            medio: formData.get('medio') || document.getElementById('medio').value,
                            espacio: formData.get('espacio') || document.getElementById('espacio').value,
                            macetas: formData.get('macetas') || document.getElementById('macetas').value,
                            iluminacion: 'led', // Siempre LED
                            potencia: formData.get('potencia') || document.getElementById('potencia').value,
                            ventilacion: 'sistema_cerrado_co2', // Siempre sistema cerrado con CO2
                            plantas: formData.get('plantas') || document.getElementById('plantas').value,
                            notas: formData.get('notas') || document.getElementById('notas').value
                        };
                        modal.remove();
                        resolve(cultivoData);
                    });
                });
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentImage = e.target.result;
                        this.previewImg.src = this.currentImage;
                        this.imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            removeImage() {
                this.currentImage = null;
                this.previewImg.src = '';
                this.imagePreview.style.display = 'none';
                this.imageInput.value = '';
            }

            async sendMessage() {
                const message = this.userInput.value.trim();
                if (!message && !this.currentImage) return;

                if (!this.currentCultivo) {
                    this.addMessage('Por favor selecciona o crea un cultivo antes de hacer consultas.', 'ai');
                    return;
                }

                // Mostrar mensaje del usuario
                this.addMessage(message, 'user', this.currentImage);

                // Limpiar input
                this.userInput.value = '';
                const imageToProcess = this.currentImage;
                this.removeImage();

                // Mostrar indicador de typing
                this.showTypingIndicator();

                try {
                    // Procesar con IA especializada
                    const response = await this.processWithCannabiAI(message, imageToProcess);
                    this.removeTypingIndicator();
                    this.addMessage(response, 'ai');

                    // Guardar mensajes en la API
                    await this.saveChatMessage('user', message, imageToProcess);
                    await this.saveChatMessage('ai', response);
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addMessage('Lo siento, hubo un error procesando tu consulta. Por favor intenta de nuevo.', 'ai');
                    console.error('Error:', error);
                }
            }

            async saveChatMessage(type, content, image = null) {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type,
                            content,
                            image
                        })
                    });

                    if (!response.ok) {
                        console.error('Error guardando mensaje en chat:', response.status);
                    }
                } catch (error) {
                    console.error('Error guardando mensaje en chat:', error);
                }
            }

            async processWithCannabiAI(text, image) {
                try {
                    // Verificar si el chat de cannabis está cargado
                    if (!this.cannabisChat) {
                        console.warn('⚠️ Chat de cannabis no disponible, intentando inicializar...');
                        this.cannabisChat = window.cannabisChat || null;
                        if (!this.cannabisChat) {
                            return 'El sistema de IA especializado no está disponible. Verifica que el archivo cannabis_chat.js se haya cargado correctamente.';
                        }
                    }

                    // Usar el nuevo chat de cannabis medicinal con OpenAI
                    if (!this.cannabisChat.isReady()) {
                        return 'Lo siento, el sistema de IA no está configurado correctamente. Verifica tu API key de OpenAI.';
                    }

                    let messageToSend = text;

                    // Si hay imagen, agregar descripción
                    if (image) {
                        const imageDescription = 'He enviado una imagen del cultivo para análisis.';
                        messageToSend = text ?
                            `${text}\n\n[Imagen adjunta: ${imageDescription}]` :
                            imageDescription;

                        // Para imágenes, usar el método específico de análisis
                        const imageResult = await this.cannabisChat.analyzeCultivoImage(image, text);
                        if (imageResult.success) {
                            return imageResult.message;
                        } else {
                            return 'Error procesando la imagen. Por favor, intenta nuevamente.';
                        }
                    }

                    // Procesar consulta de texto con el chat de cannabis
                    const result = await this.cannabisChat.processQuery(messageToSend);

                    if (result.success) {
                        return result.message;
                    } else {
                        console.error('Error en chat de cannabis:', result.error);
                        return 'Lo siento, tuve un problema procesando tu consulta. Por favor, verifica tu conexión e intenta nuevamente.';
                    }

                } catch (error) {
                    console.error('Error en processWithCannabiAI:', error);
                    return 'Lo siento, hubo un error interno. Por favor, intenta nuevamente en unos momentos.';
                }
            }

            buildCultivoContext(cultivo) {
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                return `
Cultivo: ${cultivo.nombre}
Variedad: ${cultivo.variedad}
Método: Indoor
Medio: ${medioDisplay[cultivo.medio] || cultivo.medio}
Espacio: ${cultivo.espacio}m²
Macetas: ${cultivo.macetas}L
Plantas: ${cultivo.plantas}
Iluminación: LED (${cultivo.potencia}W)
Ventilación: Sistema cerrado con CO2
Fecha de inicio: ${new Date(cultivo.fechaCreacion).toLocaleDateString()}
Notas: ${cultivo.notas || 'Sin notas adicionales'}
                `.trim();
            }

            processCannabiText(text, context) {
                const lowerText = text.toLowerCase();

                // Respuestas específicas sobre cultivo de cannabis medicinal
                if (lowerText.includes('germina') || lowerText.includes('semilla')) {
                    return `Para tu cultivo ${this.currentCultivo.nombre} (${this.currentCultivo.variedad}), te recomiendo:

**Germinación de semillas:**
- Método del papel húmedo: 24-72 horas en lugar oscuro a 22-25°C
- Trasplante cuando la radícula mida 1-2cm
- Para ${this.currentCultivo.tipo}: ${this.getVarietySpecificTips()}
- Humedad: 70-80% durante germinación

¿Necesitas detalles específicos sobre algún paso?`;
                }

                if (lowerText.includes('vegetativo') || lowerText.includes('crecimiento')) {
                    return `**Fase vegetativa para ${this.currentCultivo.variedad}:**

**Condiciones ambientales:**
- Temperatura: 20-26°C
- Humedad: 40-60%
- Fotoperíodo: 18/6 horas (luz/oscuridad)
- pH ${this.currentCultivo.medio}: ${this.getpHRange()}

**Nutrición:**
- NPK alto en Nitrógeno (ej: 20-10-10)
- Riego: cuando los primeros 2cm de sustrato estén secos
- EC: 0.8-1.2 para ${this.currentCultivo.medio}

**Para tu objetivo de ${this.currentCultivo.objetivo}:** ${this.getTherapeuticTips()}`;
                }

                if (lowerText.includes('floracion') || lowerText.includes('cogollos')) {
                    return `**Floración de ${this.currentCultivo.variedad}:**

**Cambios necesarios:**
- Fotoperíodo: 12/12 horas ${this.currentCultivo.tipo === 'autoflower' ? '(No necesario para autoflorecientes)' : ''}
- Temperatura: 18-24°C
- Humedad: 30-45% (prevenir moho)

**Nutrición:**
- NPK alto en Fósforo y Potasio (ej: 10-30-20)
- Cal-Mag suplementario
- Flush final: 1-2 semanas antes de cosecha

**Señales de madurez:** Tricomas lechosos al 70-80% para efectos terapéuticos`;
                }

                if (lowerText.includes('problema') || lowerText.includes('enfermedad') || lowerText.includes('plaga')) {
                    return `**Diagnóstico para ${this.currentCultivo.nombre}:**

**Problemas comunes en ${this.currentCultivo.metodo}:**
- **Nutritivos:** Deficiencias de N, P, K, Cal-Mag
- **Ambientales:** Temperatura, humedad, ventilación
- **Plagas:** Araña roja, trips, pulgones, mosca blanca
- **Hongos:** Oídio, botrytis, fusarium

**Describe los síntomas específicos** (color hojas, manchas, insectos visibles) y te daré un diagnóstico preciso con tratamiento orgánico adecuado para cannabis medicinal.

¿Puedes enviar una foto del problema?`;
                }

                if (lowerText.includes('cosecha') || lowerText.includes('secar') || lowerText.includes('curado')) {
                    return `**Cosecha y post-cosecha para ${this.currentCultivo.variedad}:**

**Momento óptimo:**
- Tricomas: 70% lechosos, 20% ámbar, 10% transparentes
- Para ${this.currentCultivo.objetivo}: ${this.getHarvestTiming()}

**Proceso:**
1. **Corte:** Tallo principal en oscuridad
2. **Secado:** 7-14 días, 18-21°C, 45-55% humedad
3. **Manicurado:** En seco para mejor calidad
4. **Curado:** Frascos herméticos, 60-65% humedad, 2-8 semanas

**Control de calidad medicinal:** Tests de cannabinoides y terpenos recomendados`;
                }

                if (lowerText.includes('nutrientes') || lowerText.includes('fertilizante')) {
                    return `**Plan nutricional para ${this.currentCultivo.variedad} en ${this.currentCultivo.medio}:**

**Vegetativo (semanas 1-6):**
- Base: NPK 20-10-10
- Cal-Mag: 1-2ml/L
- EC: 0.8-1.2 | pH: ${this.getpHRange()}

**Pre-floración (semanas 7-8):**
- Transición: NPK 15-15-15
- Bloom booster inicio

**Floración (semanas 9-16):**
- Base: NPK 10-30-20
- PK booster: semanas 10-14
- Enzimas y melaza para microbiología

**Flush final:** Solo agua pH ajustado últimas 1-2 semanas`;
                }

                if (lowerText.includes('iluminacion') || lowerText.includes('luz') || lowerText.includes('led') || lowerText.includes('watts')) {
                    return `**Análisis de iluminación para tu setup:**

**Tu configuración actual:**
- Sistema: ${this.currentCultivo.iluminacion || 'No especificado'}
- Potencia: ${this.currentCultivo.potencia || '?'}W
- Espacio: ${this.currentCultivo.espacio}m²
- Plantas: ${this.currentCultivo.plantas || '?'}

**Recomendaciones específicas:**
${this.getLightingAdvice()}

**Optimización por fase:**
- **Vegetativo:** 18/6 | PPFD 200-400 μmol/m²/s
- **Floración:** 12/12 | PPFD 600-900 μmol/m²/s
- **Distancia óptima:** ${this.getLightDistance()}

¿Necesitas ayuda con algún ajuste específico?`;
                }

                if (lowerText.includes('ventilacion') || lowerText.includes('temperatura') || lowerText.includes('humedad') || lowerText.includes('aire')) {
                    return `**Análisis ambiental para tu cultivo:**

**Tu setup actual:**
- Ventilación: ${this.currentCultivo.ventilacion || 'No especificado'}
- Control: ${this.currentCultivo.control || 'No especificado'}
- Espacio: ${this.currentCultivo.espacio}m²
- Método: ${this.currentCultivo.metodo}

**Parámetros ideales:**
- **Vegetativo:** 22-26°C | 40-60% HR
- **Floración:** 18-24°C | 30-45% HR
- **Renovación de aire:** ${this.getAirflowAdvice()}

**Recomendaciones específicas:**
${this.getEnvironmentalAdvice()}`;
                }

                if (lowerText.includes('maceta') || lowerText.includes('trasplante') || lowerText.includes('sustrato') || lowerText.includes('raiz')) {
                    return `**Análisis del sistema radicular:**

**Tu configuración:**
- Macetas: ${this.currentCultivo.macetas || '?'}L
- Medio: ${this.currentCultivo.medio}
- Plantas: ${this.currentCultivo.plantas || '?'}
- Espacio por planta: ${this.getSpacePerPlant()}

**Recomendaciones:**
${this.getContainerAdvice()}

**Cronograma de trasplantes:**
- Semilla → 0.5L (germinación)
- Plántula → 3-5L (vegetativo temprano)
- Vegetativo → ${this.currentCultivo.macetas}L (final)
- **Timing:** Cuando las raíces cubran 80% del sustrato`;
                }

                if (lowerText.includes('entrenamiento') || lowerText.includes('poda') || lowerText.includes('lst') || lowerText.includes('scrog')) {
                    return `**Técnicas de entrenamiento para ${this.currentCultivo.variedad}:**

**Tu método actual:** ${this.currentCultivo.entrenamiento || 'Natural'}

**Recomendaciones específicas:**
${this.getTrainingAdvice()}

**Cronograma óptimo:**
- **Semana 3-4:** Inicio de técnicas low-stress
- **Semana 5-6:** Técnicas high-stress (si aplica)
- **Pre-floración:** Últimos ajustes y defoliación

**Para tu espacio (${this.currentCultivo.espacio}m²):** ${this.getSpaceOptimizationTips()}`;
                }

                // Respuesta general con contexto del cultivo
                return `Como especialista en cannabis medicinal, analizo tu consulta sobre "${text}" para tu cultivo:

${context}

Para darte la respuesta más precisa, ¿podrías especificar:
- ¿En qué fase está tu cultivo actualmente?
- ¿Hay algún síntoma o problema específico?
- ¿Buscas información preventiva o correctiva?

Mi experiencia incluye cultivo medicinal de alta calidad, con enfoque en maximizar cannabinoides y terpenos para aplicaciones terapéuticas específicas.`;
            }

            getVarietySpecificTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('auto') || variedad.includes('autoflower')) {
                    return 'Germinar directo en maceta final, no trasplantar. Autofloreciente.';
                } else if (variedad.includes('indica') || variedad.includes('afghan') || variedad.includes('kush')) {
                    return 'Las índicas germinan más lento pero son más resistentes.';
                } else if (variedad.includes('sativa') || variedad.includes('thai') || variedad.includes('jamaican')) {
                    return 'Las sativas necesitan más cuidado en germinación, mayor temperatura.';
                } else {
                    return 'Comportamiento híbrido equilibrado, seguir protocolo estándar.';
                }
            }

            getpHRange() {
                const medio = this.currentCultivo.medio;
                switch (medio) {
                    case 'fibra_coco':
                    case 'fibra_coco_perlita': return '5.5-6.2';
                    case 'light_mix': return '6.0-6.8';
                    case 'hidro': return '5.5-6.0';
                    default: return '6.0-6.5';
                }
            }

            getTherapeuticTips() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte') || variedad.includes('acdc')) {
                    return 'Variedad alta en CBD, ideal para usos medicinales con bajo psicoactivo.';
                } else if (variedad.includes('thc') || variedad.includes('gorilla') || variedad.includes('amnesia')) {
                    return 'Variedad alta en THC, enfocarse en control de dosis.';
                } else {
                    return 'Variedad equilibrada, monitorear perfil de cannabinoides durante floración.';
                }
            }

            getHarvestTiming() {
                const variedad = this.currentCultivo.variedad?.toLowerCase() || '';

                if (variedad.includes('cbd') || variedad.includes('charlotte')) {
                    return 'Cosechar cuando tricomas estén 50-60% lechosos para máximo CBD.';
                } else if (variedad.includes('thc') || variedad.includes('skunk') || variedad.includes('haze')) {
                    return 'Esperar a que tricomas estén 70-80% lechosos para máximo THC.';
                } else {
                    return 'Monitorear tricomas: 70% lechosos, 20% ámbar, 10% transparentes para balance óptimo.';
                }
            }

            analyzeCannabiImage(image, context) {
                return `He analizado la imagen de tu cultivo ${this.currentCultivo.nombre}.

**Análisis visual basado en:**
${context}

Puedo evaluar:
- **Estado de las hojas:** Color, textura, posibles deficiencias
- **Estructura de la planta:** Desarrollo, entrenudos
- **Flores/cogollos:** Madurez, densidad, tricomas
- **Problemas:** Plagas, enfermedades, estrés

**Para un diagnóstico más preciso, describe:**
- ¿Qué problema específico observas?
- ¿Cuándo comenzaste a notarlo?
- ¿Cambios recientes en nutrición/ambiente?

Basándome en tu variedad ${this.currentCultivo.variedad} y método ${this.currentCultivo.metodo}, te daré recomendaciones específicas.`;
            }

            analyzeCannabiImageWithText(text, image, context) {
                return `Perfecto, he analizado tu imagen junto con tu consulta: "${text}".

**Cultivo analizado:**
${context}

**Análisis combinado:**
Basándome en la imagen y tu descripción, puedo darte un diagnóstico más preciso para tu ${this.currentCultivo.variedad}.

**Recomendaciones específicas:**
- Evaluación visual confirmada con tu descripción
- Protocolo de tratamiento adaptado a ${this.currentCultivo.metodo}
- Considerando objetivo terapéutico: ${this.currentCultivo.objetivo}

**Próximos pasos:**
1. Monitoreo diario de la evolución
2. Ajustes específicos según diagnóstico
3. Seguimiento fotográfico para comparar progreso

¿Necesitas el protocolo detallado de tratamiento?`;
            }

            showWelcomeMessage() {
                this.chatHistory.innerHTML = `
                    <div class="message ai-message welcome-message">
                        <div class="message-content">
                            <div class="welcome-header">
                                <div class="welcome-avatar">🧠</div>
                                <div class="welcome-intro">
                                    <h2>¡Hola! Soy Dr. Bruce Bugbee</h2>
                                    <p>Tu experto en cannabis medicinal con más de 25 años de experiencia</p>
                                </div>
                            </div>

                            <div class="welcome-features">
                                <h3>🌱 ¿En qué puedo ayudarte?</h3>
                                <div class="features-grid">
                                    <div class="feature-item">
                                        <i class="fas fa-seedling"></i>
                                        <h4>Técnicas de Cultivo</h4>
                                        <p>Métodos avanzados para cannabis medicinal de alta calidad</p>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-chart-line"></i>
                                        <h4>Optimización</h4>
                                        <p>Maximiza perfiles de cannabinoides (THC/CBD)</p>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-search"></i>
                                        <h4>Diagnóstico</h4>
                                        <p>Identifica y soluciona problemas en tus plantas</p>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-cut"></i>
                                        <h4>Cosecha & Curado</h4>
                                        <p>Protocolos para máxima potencia terapéutica</p>
                                    </div>
                                </div>
                            </div>

                            <div class="getting-started">
                                <h3>🚀 Para comenzar:</h3>
                                <div class="steps">
                                    <div class="step">
                                        <span class="step-number">1</span>
                                        <div class="step-content">
                                            <h4>Crea tu cultivo</h4>
                                            <p>Configura los parámetros específicos de tu setup</p>
                                        </div>
                                    </div>
                                    <div class="step">
                                        <span class="step-number">2</span>
                                        <div class="step-content">
                                            <h4>Selecciona el cultivo</h4>
                                            <p>Todas mis respuestas serán personalizadas</p>
                                        </div>
                                    </div>
                                    <div class="step">
                                        <span class="step-number">3</span>
                                        <div class="step-content">
                                            <h4>¡Pregunta lo que necesites!</h4>
                                            <p>Envía texto o fotos para análisis detallado</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tip-box">
                                <i class="fas fa-lightbulb"></i>
                                <p><strong>Tip:</strong> Puedes usar las sugerencias rápidas de abajo o enviar fotos de tus plantas para análisis visual.</p>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        .welcome-message {
                            max-width: 100% !important;
                            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(76, 175, 80, 0.05));
                            border: 2px solid rgba(46, 125, 50, 0.2);
                        }
                        
                        .welcome-header {
                            display: flex;
                            align-items: center;
                            gap: var(--spacing-lg);
                            margin-bottom: var(--spacing-xl);
                            padding-bottom: var(--spacing-lg);
                            border-bottom: 1px solid rgba(46, 125, 50, 0.2);
                        }
                        
                        .welcome-avatar {
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 36px;
                            box-shadow: var(--shadow-lg);
                            flex-shrink: 0;
                        }
                        
                        .welcome-intro h2 {
                            margin: 0 0 var(--spacing-sm) 0;
                            color: var(--primary-green);
                            font-size: 24px;
                            font-weight: 700;
                        }
                        
                        .welcome-intro p {
                            margin: 0;
                            color: var(--text-secondary);
                            font-size: 16px;
                        }
                        
                        .welcome-features {
                            margin-bottom: var(--spacing-xl);
                        }
                        
                        .welcome-features h3 {
                            color: var(--primary-green);
                            margin-bottom: var(--spacing-lg);
                            font-size: 20px;
                        }
                        
                        .features-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                            gap: var(--spacing-lg);
                            margin-bottom: var(--spacing-lg);
                        }
                        
                        .feature-item {
                            padding: var(--spacing-lg);
                            background: rgba(255, 255, 255, 0.7);
                            border-radius: var(--radius-lg);
                            text-align: center;
                            border: 1px solid rgba(46, 125, 50, 0.1);
                            transition: all 0.3s ease;
                        }
                        
                        .feature-item:hover {
                            transform: translateY(-2px);
                            box-shadow: var(--shadow-md);
                            border-color: rgba(46, 125, 50, 0.3);
                        }
                        
                        .feature-item i {
                            font-size: 24px;
                            color: var(--secondary-green);
                            margin-bottom: var(--spacing-sm);
                        }
                        
                        .feature-item h4 {
                            margin: 0 0 var(--spacing-sm) 0;
                            color: var(--text-primary);
                            font-size: 16px;
                            font-weight: 600;
                        }
                        
                        .feature-item p {
                            margin: 0;
                            color: var(--text-secondary);
                            font-size: 14px;
                            line-height: 1.5;
                        }
                        
                        .getting-started h3 {
                            color: var(--primary-green);
                            margin-bottom: var(--spacing-lg);
                            font-size: 20px;
                        }
                        
                        .steps {
                            display: flex;
                            flex-direction: column;
                            gap: var(--spacing-lg);
                            margin-bottom: var(--spacing-xl);
                        }
                        
                        .step {
                            display: flex;
                            align-items: flex-start;
                            gap: var(--spacing-md);
                        }
                        
                        .step-number {
                            width: 32px;
                            height: 32px;
                            background: var(--primary-green);
                            color: var(--text-white);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 600;
                            font-size: 14px;
                            flex-shrink: 0;
                        }
                        
                        .step-content h4 {
                            margin: 0 0 var(--spacing-xs) 0;
                            color: var(--text-primary);
                            font-size: 16px;
                            font-weight: 600;
                        }
                        
                        .step-content p {
                            margin: 0;
                            color: var(--text-secondary);
                            font-size: 14px;
                        }
                        
                        .tip-box {
                            display: flex;
                            align-items: flex-start;
                            gap: var(--spacing-md);
                            padding: var(--spacing-lg);
                            background: rgba(255, 193, 7, 0.1);
                            border-radius: var(--radius-md);
                            border-left: 4px solid #ffc107;
                        }
                        
                        .tip-box i {
                            color: #ffc107;
                            font-size: 18px;
                            margin-top: 2px;
                            flex-shrink: 0;
                        }
                        
                        .tip-box p {
                            margin: 0;
                            color: var(--text-primary);
                            font-size: 14px;
                            line-height: 1.5;
                        }
                        
                        @media (max-width: 768px) {
                            .welcome-header {
                                flex-direction: column;
                                text-align: center;
                                gap: var(--spacing-md);
                            }
                            
                            .welcome-avatar {
                                width: 60px;
                                height: 60px;
                                font-size: 28px;
                            }
                            
                            .welcome-intro h2 {
                                font-size: 20px;
                            }
                            
                            .features-grid {
                                grid-template-columns: 1fr;
                                gap: var(--spacing-md);
                            }
                            
                            .feature-item {
                                padding: var(--spacing-md);
                            }
                        }
                    </style>
                `;
            }

            async loadCultivoNotes() {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const notes = result.data.notas || [];
                        if (this.cannabisChat) {
                            this.cannabisChat.setCultivoNotes(notes);
                            console.log('✅ Notas del cultivo cargadas para contexto:', notes.length);
                        } else if (window.cannabisChat) {
                            this.cannabisChat = window.cannabisChat;
                            this.cannabisChat.setCultivoNotes(notes);
                            console.log('✅ Notas del cultivo cargadas para contexto:', notes.length);
                        }
                    } else {
                        console.warn('⚠️ No se pudieron cargar las notas del cultivo');
                        if (this.cannabisChat) {
                            this.cannabisChat.setCultivoNotes([]);
                        } else if (window.cannabisChat) {
                            this.cannabisChat = window.cannabisChat;
                            this.cannabisChat.setCultivoNotes([]);
                        }
                    }
                } catch (error) {
                    console.error('Error cargando notas del cultivo:', error);
                    if (this.cannabisChat) {
                        this.cannabisChat.setCultivoNotes([]);
                    } else if (window.cannabisChat) {
                        this.cannabisChat = window.cannabisChat;
                        this.cannabisChat.setCultivoNotes([]);
                    }
                }
            }

            loadCultivoChat() {
                this.chatHistory.innerHTML = '';

                // Mensaje de contexto del cultivo con Bruce Bugbee
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.addMessage(`<h2>🌱 ${this.currentCultivo.nombre}</h2>

<h3>📋 Configuración Actual</h3>

<div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
<p><strong>Variedad:</strong> ${this.currentCultivo.variedad}</p>
<p><strong>Método:</strong> Indoor con CO2</p>
<p><strong>Medio:</strong> ${medioDisplay[this.currentCultivo.medio] || this.currentCultivo.medio}</p>
<p><strong>Espacio:</strong> ${this.currentCultivo.espacio}m²</p>
<p><strong>Plantas:</strong> ${this.currentCultivo.plantas || '?'}</p>
<p><strong>Iluminación:</strong> LED ${this.currentCultivo.potencia || '?'}W</p>
</div>

<h3>🎯 ¿En qué puedo ayudarte?</h3>

<ul>
<li><strong>Técnicas de cultivo</strong> optimizadas para tu variedad</li>
<li><strong>Diagnóstico</strong> de problemas específicos en tiempo real</li>
<li><strong>Recomendaciones</strong> basadas en evidencia científica</li>
<li><strong>Protocolos</strong> de cosecha y curado terapéutico</li>
<li><strong>Optimización</strong> de perfiles cannabinoides (THC/CBD)</li>
</ul>

<p>¡Pregúntame cualquier cosa sobre tu cultivo medicinal!</p>`, 'ai');

                // Cargar historial previo desde la API
                if (this.currentCultivo.chatHistory && this.currentCultivo.chatHistory.length > 0) {
                    this.currentCultivo.chatHistory.forEach(msg => {
                        this.addMessage(msg.content, msg.type, msg.image);
                    });
                }
            }

            togglePanel(panel, open) {
                if (typeof open === 'undefined') {
                    open = !panel.classList.contains('open');
                }
                panel.classList.toggle('open', open);
                if (panel === this.infoPanel) {
                    this.openInfoBtn.style.display = open ? 'none' : 'block';
                } else if (panel === this.notesPanel) {
                    this.openNotesBtn.style.display = open ? 'none' : 'block';
                    if (open && this.currentCultivo) {
                        this.loadNotasFromAPI();
                    }
                }
            }

            updateInfoPanel() {
                if (!this.currentCultivo) {
                    this.infoContent.innerHTML = '<p>Selecciona un cultivo para ver la información.</p>';
                    this.notesArea.value = '';
                    return;
                }

                const c = this.currentCultivo;
                const medioDisplay = {
                    'fibra_coco': 'Fibra de coco',
                    'fibra_coco_perlita': 'Fibra de coco + perlita',
                    'light_mix': 'Light mix',
                    'hidro': 'Hidro'
                };

                this.infoContent.innerHTML = `
                    <div class="cultivo-header">
                        <h3 contenteditable="true" class="editable-field" data-field="nombre">${c.nombre}</h3>
                        <div class="cultivo-actions">
                            <button class="edit-info-btn" title="Editar información">✏️</button>
                            <button class="save-info-btn" title="Guardar cambios" style="display: none;">💾</button>
                        </div>
                    </div>

                    <div class="cultivo-info-grid">
                        <div class="info-item">
                            <label>Variedad:</label>
                            <span contenteditable="true" class="editable-field" data-field="variedad">${c.variedad}</span>
                        </div>
                        <div class="info-item">
                            <label>Método:</label>
                            <span>Indoor</span>
                        </div>
                        <div class="info-item">
                            <label>Medio:</label>
                            <span contenteditable="true" class="editable-field" data-field="medio">${medioDisplay[c.medio] || c.medio}</span>
                        </div>
                        <div class="info-item">
                            <label>Espacio:</label>
                            <span contenteditable="true" class="editable-field" data-field="espacio">${c.espacio}</span>m²
                        </div>
                        <div class="info-item">
                            <label>Plantas:</label>
                            <span contenteditable="true" class="editable-field" data-field="plantas">${c.plantas || '?'}</span>
                        </div>
                        <div class="info-item">
                            <label>Macetas:</label>
                            <span contenteditable="true" class="editable-field" data-field="macetas">${c.macetas || '?'}</span>L
                        </div>
                        <div class="info-item">
                            <label>Iluminación:</label>
                            <span>LED (<span contenteditable="true" class="editable-field" data-field="potencia">${c.potencia || '?'}</span>W)</span>
                        </div>
                        <div class="info-item">
                            <label>Ventilación:</label>
                            <span>Sistema cerrado con CO2</span>
                        </div>
                    </div>

                    <div class="cultivo-notas-section">
                        <h4>📝 Notas del Cultivo</h4>
                        <div class="notas-drop-zone" id="notas-drop-zone">
                            <p class="drop-hint">Arrastra notas aquí para agregar información...</p>
                        </div>
                    </div>
                `;

                // Configurar eventos para edición inline
                this.setupInlineEditing();

                // Configurar drag & drop
                this.setupDragAndDrop();

                // Mostrar notas recientes en el panel de información
                if (c.notas && c.notas.length > 0) {
                    this.displayNotasInInfoPanel(c.notas);
                }
            }

            setupInlineEditing() {
                const editBtn = this.infoContent.querySelector('.edit-info-btn');
                const saveBtn = this.infoContent.querySelector('.save-info-btn');
                const editableFields = this.infoContent.querySelectorAll('.editable-field');

                if (editBtn && saveBtn) {
                    editBtn.addEventListener('click', () => {
                        editableFields.forEach(field => {
                            field.classList.add('editing');
                        });
                        editBtn.style.display = 'none';
                        saveBtn.style.display = 'inline-block';
                    });

                    saveBtn.addEventListener('click', () => {
                        this.saveInlineEdits();
                        editableFields.forEach(field => {
                            field.classList.remove('editing');
                        });
                        editBtn.style.display = 'inline-block';
                        saveBtn.style.display = 'none';
                    });
                }

                // Auto-guardar al presionar Enter
                editableFields.forEach(field => {
                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.saveInlineEdits();
                            editableFields.forEach(f => f.classList.remove('editing'));
                            editBtn.style.display = 'inline-block';
                            saveBtn.style.display = 'none';
                        } else if (e.key === 'Escape') {
                            // Cancelar edición
                            this.updateInfoPanel();
                        }
                    });

                    field.addEventListener('blur', () => {
                        if (field.classList.contains('editing')) {
                            this.saveInlineEdits();
                            editableFields.forEach(f => f.classList.remove('editing'));
                            editBtn.style.display = 'inline-block';
                            saveBtn.style.display = 'none';
                        }
                    });
                });
            }

            async saveInlineEdits() {
                if (!this.currentCultivo) return;

                const editableFields = this.infoContent.querySelectorAll('.editable-field');
                const updates = {};

                editableFields.forEach(field => {
                    const fieldName = field.dataset.field;
                    let value = field.textContent.trim();

                    // Limpiar unidades y formatear según el campo
                    if (fieldName === 'espacio') {
                        value = value.replace('m²', '').trim();
                    } else if (fieldName === 'macetas') {
                        value = value.replace('L', '').trim();
                    } else if (fieldName === 'potencia') {
                        value = value.replace('W', '').trim();
                    }

                    updates[fieldName] = value;
                });

                try {
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.currentCultivo = result.data;
                        this.cultivos[this.currentCultivo.id] = this.currentCultivo;
                        this.updateCultivoDropdown();
                        this.addMessage('✅ Información del cultivo actualizada exitosamente', 'ai');
                    } else {
                        const error = await response.json();
                        this.addMessage(`❌ Error actualizando información: ${error.error}`, 'ai');
                        // Revertir cambios visuales
                        this.updateInfoPanel();
                    }
                } catch (error) {
                    console.error('Error guardando cambios:', error);
                    this.addMessage('❌ Error interno guardando cambios', 'ai');
                    this.updateInfoPanel();
                }
            }

            setupDragAndDrop() {
                const dropZone = this.infoContent.querySelector('#notas-drop-zone');
                if (!dropZone) return;

                // Configurar zona de drop
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');

                    const notaData = JSON.parse(e.dataTransfer.getData('application/json'));
                    this.addNotaToCultivo(notaData);
                });
            }

            displayNotasInInfoPanel(notas) {
                const dropZone = this.infoContent.querySelector('#notas-drop-zone');
                if (!dropZone || !notas.length) return;

                const notasHTML = notas.map(nota => {
                    const fecha = new Date(nota.fecha).toLocaleString();
                        const tipoIcon = this.getTipoNotaIcon(nota.tipo);
                    const tipoLabel = nota.tipo.charAt(0).toUpperCase() + nota.tipo.slice(1);

                    return `
                        <div class="nota-in-info ${nota.importante ? 'importante' : ''}" data-nota-id="${nota.id}">
                            <div class="nota-in-info-header">
                                <span class="nota-tipo">${tipoIcon} ${tipoLabel}</span>
                                <span class="nota-fecha">${fecha}</span>
                                ${nota.importante ? '<span class="nota-importante">⭐</span>' : ''}
                                <button class="remove-nota-btn" onclick="this.closest('.nota-in-info').remove()">×</button>
                            </div>
                            <div class="nota-in-info-content">${nota.contenido}</div>
                        </div>
                    `;
                }).join('');

                dropZone.innerHTML = notasHTML;
            }

            async addNotaToCultivo(notaData) {
                if (!this.currentCultivo) return;

                try {
                    // Agregar la nota al cultivo actual (actualizar notas del cultivo)
                    if (!this.currentCultivo.notas) {
                        this.currentCultivo.notas = [];
                    }
                    this.currentCultivo.notas.push(notaData);

                    // Actualizar visualmente
                    this.displayNotasInInfoPanel(this.currentCultivo.notas);

                    // Guardar en la API si es necesario
                    const response = await fetch(`/api/cultivos/${this.currentCultivo.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            notas: this.currentCultivo.notas
                        })
                    });

                    if (response.ok) {
                        this.addMessage('✅ Nota agregada al cultivo exitosamente', 'ai');
                    } else {
                        console.error('Error guardando nota en cultivo');
                    }
                } catch (error) {
                    console.error('Error agregando nota al cultivo:', error);
                    this.addMessage('❌ Error agregando nota al cultivo', 'ai');
                }
            }

            async saveNotes() {
                if (!this.currentCultivo) return;

                // Obtener valores del formulario
                const tipoSelect = document.getElementById('note-type');
                const importanteCheckbox = document.getElementById('note-important');

                const tipo = tipoSelect ? tipoSelect.value : 'general';
                const importante = importanteCheckbox ? importanteCheckbox.checked : false;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contenido: this.notesArea.value,
                            tipo: tipo,
                            importante: importante
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.addMessage('✅ Nota guardada exitosamente', 'ai');
                        // Actualizar el cultivo local con la nueva nota
                        if (!this.currentCultivo.notas) {
                            this.currentCultivo.notas = [];
                        }
                        this.currentCultivo.notas.push(result.data.nuevaNota);
                        // Limpiar el textarea después de guardar
                        this.notesArea.value = '';
                        // Actualizar el panel de información para mostrar las notas recientes
                        this.updateInfoPanel();
                        // Actualizar el panel lateral de notas si está abierto
                        this.updateNotesPanel();
                    } else {
                        const error = await response.json();
                        this.addMessage(`❌ Error guardando nota: ${error.error}`, 'ai');
                    }
                } catch (error) {
                    console.error('Error guardando nota:', error);
                    this.addMessage('❌ Error interno guardando nota', 'ai');
                }
            }

            getTipoNotaIcon(tipo) {
                const iconos = {
                    'general': '📝',
                    'vegetativo': '🌱',
                    'floracion': '🌸',
                    'cosecha': '✂️',
                    'recordatorio': '⏰',
                    'comentario': '💬'
                };
                return iconos[tipo] || '📝';
            }

            updateNotesPanel() {
                if (!this.currentCultivo || !this.notesPanel.classList.contains('open')) return;

                const notesContent = this.notesPanel.querySelector('.side-content');
                const notesList = notesContent.querySelector('.notes-list');

                if (notesList && this.currentCultivo.notas) {
                    notesList.innerHTML = this.renderDraggableNotasList(this.currentCultivo.notas);
                }
            }

            async loadNotasFromAPI() {
                if (!this.currentCultivo) return;

                try {
                    const response = await fetch(`${this.getApiBaseUrl()}/cultivos/${this.currentCultivo.id}/notas`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Actualizar las notas del cultivo con las de la API
                        this.currentCultivo.notas = result.data.notas;
                        this.updateNotesPanelUI();
                    } else {
                        console.error('Error cargando notas desde API:', response.status);
                    }
                } catch (error) {
                    console.error('Error cargando notas desde API:', error);
                }
            }

            updateNotesPanelUI() {
                const notesContent = this.notesPanel.querySelector('.side-content');
                if (!notesContent) return;

                notesContent.innerHTML = `
                    <div class="notes-history">
                        <div class="notes-header">
                            <h4>📝 Historial de Notas</h4>
                            <span class="notes-count">${this.currentCultivo.notas ? this.currentCultivo.notas.length : 0} notas</span>
                            <div class="drag-hint">💡 Arrastra notas al panel izquierdo</div>
                        </div>
                        <div class="notes-list">
                            ${this.renderDraggableNotasList(this.currentCultivo.notas || [])}
                        </div>
                        <div class="add-note-section">
                            <textarea id="notes-area" placeholder="Escribe una nueva nota..." rows="3"></textarea>
                            <div class="note-options">
                                <select id="note-type" class="note-type-select">
                                    <option value="general">📝 General</option>
                                    <option value="vegetativo">🌱 Vegetativo</option>
                                    <option value="floracion">🌸 Floración</option>
                                    <option value="cosecha">✂️ Cosecha</option>
                                    <option value="recordatorio">⏰ Recordatorio</option>
                                    <option value="comentario">💬 Comentario</option>
                                </select>
                                <label class="important-checkbox">
                                    <input type="checkbox" id="note-important"> Importante
                                </label>
                                <button id="save-notes" class="save-notes-btn">💾 Guardar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Reasignar referencias después de recrear el DOM
                this.notesArea = document.getElementById('notes-area');
                this.saveNotesBtn = document.getElementById('save-notes');

                // Reasignar event listeners
                if (this.saveNotesBtn) {
                    this.saveNotesBtn.addEventListener('click', () => this.saveNotes());
                }

                // Configurar drag & drop para las notas
                this.setupNotasDragAndDrop();
            }

            renderDraggableNotasList(notas) {
                if (!notas || notas.length === 0) {
                    return '<p class="no-notes">No hay notas aún. ¡Agrega la primera!</p>';
                }

                // Ordenar por fecha descendente (más recientes primero)
                const notasOrdenadas = notas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                return notasOrdenadas.map(nota => {
                    const fecha = new Date(nota.fecha).toLocaleString();
                    const tipoIcon = this.getTipoNotaIcon(nota.tipo);
                    const tipoLabel = nota.tipo.charAt(0).toUpperCase() + nota.tipo.slice(1);
                    const importanteClass = nota.importante ? 'importante' : '';

                    return `
                        <div class="nota-item ${importanteClass} draggable-nota" draggable="true" data-nota='${JSON.stringify(nota)}'>
                            <div class="nota-header">
                                <span class="nota-tipo">${tipoIcon} ${tipoLabel}</span>
                                <span class="nota-fecha">${fecha}</span>
                                ${nota.importante ? '<span class="nota-importante">⭐</span>' : ''}
                                <span class="drag-handle">⋮⋮</span>
                            </div>
                            <div class="nota-contenido">${nota.contenido}</div>
                            ${nota.fase ? `<div class="nota-fase">Fase: ${nota.fase}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            setupNotasDragAndDrop() {
                const draggableNotas = this.notesPanel.querySelectorAll('.draggable-nota');

                draggableNotas.forEach(nota => {
                    nota.addEventListener('dragstart', (e) => {
                        const notaData = JSON.parse(nota.dataset.nota);
                        e.dataTransfer.setData('application/json', JSON.stringify(notaData));
                        e.dataTransfer.effectAllowed = 'copy';
                        nota.classList.add('dragging');
                    });

                    nota.addEventListener('dragend', () => {
                        nota.classList.remove('dragging');
                    });
                });
            }

            renderNotasList(notas) {
                // Método de compatibilidad para casos donde no se necesita drag & drop
                if (!notas || notas.length === 0) {
                    return '<p class="no-notes">No hay notas aún. ¡Agrega la primera!</p>';
                }

                // Ordenar por fecha descendente (más recientes primero)
                const notasOrdenadas = notas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                return notasOrdenadas.map(nota => {
                    const fecha = new Date(nota.fecha).toLocaleString();
                    const tipoIcon = this.getTipoNotaIcon(nota.tipo);
                    const tipoLabel = nota.tipo.charAt(0).toUpperCase() + nota.tipo.slice(1);
                    const importanteClass = nota.importante ? 'importante' : '';

                    return `
                        <div class="nota-item ${importanteClass}">
                            <div class="nota-header">
                                <span class="nota-tipo">${tipoIcon} ${tipoLabel}</span>
                                <span class="nota-fecha">${fecha}</span>
                                ${nota.importante ? '<span class="nota-importante">⭐</span>' : ''}
                            </div>
                            <div class="nota-contenido">${nota.contenido}</div>
                            ${nota.fase ? `<div class="nota-fase">Fase: ${nota.fase}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            addMessage(content, sender, image = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                let messageContent = `
                    <div class="message-content">
                        <strong>${sender === 'user' ? 'Tú' : 'Bruce'}:</strong> 
                `;

                if (image && sender === 'user') {
                    messageContent += `
                        <div class="message-image">
                            <img src="${image}" alt="Imagen enviada" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin: 8px 0;">
                        </div>
                    `;
                }

                if (content) {
                    // Procesar el contenido para mejor formato
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negritas
                        .replace(/^• (.*)$/gm, '<li>$1</li>') // Convertir viñetas a listas
                        .replace(/^(\d+)\. (.*)$/gm, '<li>$1. $2</li>') // Convertir numeración a listas
                        .replace(/\n\n/g, '</p><p>') // Convertir párrafos
                        .replace(/\n/g, '<br>'); // Saltos de línea

                    // Si hay listas, envolverlas en ul
                    if (formattedContent.includes('<li>')) {
                        formattedContent = '<ul>' + formattedContent.replace(/(<li>.*?<\/li>)/g, '$1') + '</ul>';
                        formattedContent = formattedContent.replace('<ul><ul>', '<ul>').replace('</ul></ul>', '</ul>');
                    }

                    // Envolver en párrafos si no hay listas
                    if (!formattedContent.includes('<ul>') && !formattedContent.includes('<ol>')) {
                        formattedContent = '<p>' + formattedContent + '</p>';
                    }

                    messageContent += `<span>${formattedContent}</span>`;
                }

                messageContent += `
                        <div class="timestamp">${new Date().toLocaleString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit',
                            day: '2-digit',
                            month: '2-digit'
                        })}</div>
                    </div>
                `;

                messageDiv.innerHTML = messageContent;
                this.chatHistory.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message typing-indicator';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <strong>Bruce:</strong> 
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                `;
                this.chatHistory.appendChild(typingDiv);
                this.scrollToBottom();
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            scrollToBottom() {
                this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            getLightingAdvice() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const wattsPerM2 = potencia / espacio;

                let advice = `Sistema LED de alta calidad para cultivo indoor.`;

                if (wattsPerM2 < 100) {
                    advice += ` Considera aumentar la potencia para mejor rendimiento (actual: ${wattsPerM2.toFixed(0)}W/m²).`;
                } else if (wattsPerM2 > 300) {
                    advice += ` Potencia excelente (${wattsPerM2.toFixed(0)}W/m²), asegurar buena ventilación por el calor generado.`;
                } else {
                    advice += ` Potencia adecuada (${wattsPerM2.toFixed(0)}W/m²) para buen desarrollo.`;
                }

                return advice;
            }

            getLightDistance() {
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                if (potencia <= 300) {
                    return '30-45cm (para LEDs de baja potencia)';
                } else if (potencia <= 600) {
                    return '45-60cm (para LEDs de media potencia)';
                } else {
                    return '60-80cm (para LEDs de alta potencia, ajustar por calor)';
                }
            }

            getAirflowAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const volumen = espacio * 2.5; // Asumiendo 2.5m de altura
                const renovacionPorMinuto = volumen * 1.5; // 1.5 veces por minuto
                return `${renovacionPorMinuto.toFixed(0)} m³/min para tu espacio de ${volumen}m³`;
            }

            getEnvironmentalAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const potencia = parseInt(this.currentCultivo.potencia) || 0;

                let advice = 'Sistema cerrado con CO2 óptimo para control de ambiente. ';

                if (potencia > 600) {
                    advice += 'Alta potencia requiere buena renovación de aire para controlar temperatura.';
                } else {
                    advice += 'Mantén CO2 entre 800-1200ppm para máximo rendimiento.';
                }

                advice += ' Monitoreo constante de temperatura y humedad recomendado.';

                return advice;
            }

            getSpacePerPlant() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const spacePer = (espacio / plantas);
                return `${spacePer.toFixed(2)}m² por planta`;
            }

            getContainerAdvice() {
                const macetas = parseInt(this.currentCultivo.macetas) || 0;
                const medio = this.currentCultivo.medio;

                let advice = '';

                // Recomendaciones basadas en tamaño de macetas
                if (macetas < 11) {
                    advice = 'Para buen desarrollo radicular, considerar macetas de 11L o más (actual: ' + macetas + 'L). ';
                } else if (macetas >= 50) {
                    advice = 'Macetas grandes excelentes para desarrollo completo (actual: ' + macetas + 'L). ';
                }

                // Recomendaciones basadas en medio
                if (medio === 'fibra_coco' || medio === 'fibra_coco_perlita') {
                    advice += 'Fibra de coco drena excelente, permite buen control de humedad.';
                } else if (medio === 'light_mix') {
                    advice += 'Light mix retiene nutrientes bien, monitorear pH regularmente.';
                } else if (medio === 'hidro') {
                    advice += 'Sistema hidropónico requiere recirculación constante.';
                }

                return advice;
            }

            getTrainingAdvice() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;
                const densidad = espacio / plantas;

                let advice = '';

                if (densidad > 1) {
                    advice = `Espacio generoso (${densidad.toFixed(1)}m²/planta). Ideal para técnicas LST o SCROG para maximizar rendimiento.`;
                } else if (densidad < 0.5) {
                    advice = `Espacio limitado. Considera técnicas SOG o plantas más compactas.`;
                } else {
                    advice = `Densidad equilibrada. Cualquier técnica de entrenamiento funcionará bien.`;
                }

                advice += ` Recomiendo LST (Low Stress Training) para principiantes - comenzar en semana 3-4.`;

                return advice;
            }

            getSpaceOptimizationTips() {
                const espacio = parseFloat(this.currentCultivo.espacio) || 1;
                const plantas = parseInt(this.currentCultivo.plantas) || 1;

                if (espacio / plantas > 1) {
                    return 'Espacio generoso, ideal para técnicas LST/SCROG.';
                } else if (espacio / plantas < 0.5) {
                    return 'Espacio limitado, considera SOG o plantas más pequeñas.';
                } else {
                    return 'Densidad equilibrada, cualquier técnica funcionará bien.';
                }
            }
        }

        // Estilos mejorados para el chat de Bruce
        const chatStyles = `
            <style>
                /* Estilos mejorados para el chat de cannabis medicinal */
                .chat-container {
                    max-width: 900px;
                    margin: 20px auto;
                    height: 75vh;
                    display: flex;
                    flex-direction: column;
                    border: 2px solid #2d5a27;
                    border-radius: 15px;
                    overflow: hidden;
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    box-shadow: 0 8px 25px rgba(45, 90, 39, 0.15);
                    position: relative;
                }

                .chat-container::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(90deg, #4CAF50, #2d5a27, #4CAF50);
                }

                .chat-history {
                    flex: 1;
                    overflow-y: auto;
                    padding: 25px;
                    background: transparent;
                    scroll-behavior: smooth;
                    scrollbar-width: thin;
                    scrollbar-color: #4CAF50 #f1f1f1;
                }

                .chat-history::-webkit-scrollbar {
                    width: 6px;
                }

                .chat-history::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 10px;
                }

                .chat-history::-webkit-scrollbar-thumb {
                    background: #4CAF50;
                    border-radius: 10px;
                }

                .chat-history::-webkit-scrollbar-thumb:hover {
                    background: #2d5a27;
                }

                .message {
                    margin-bottom: 25px;
                    padding: 20px 25px;
                    border-radius: 18px;
                    max-width: 85%;
                    word-wrap: break-word;
                    position: relative;
                    animation: messageSlideIn 0.3s ease-out;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                    backdrop-filter: blur(10px);
                }

                @keyframes messageSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .user-message {
                    background: linear-gradient(135deg, #4CAF50, #2d5a27);
                    color: white;
                    margin-left: auto;
                    border-bottom-right-radius: 5px;
                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                }

                .user-message::before {
                    content: '👤';
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }

                .ai-message {
                    background: linear-gradient(135deg, #ffffff, #f8f9fa);
                    color: #2d3748;
                    margin-right: auto;
                    border: 2px solid #e2e8f0;
                    border-bottom-left-radius: 5px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                }

                .ai-message::before {
                    content: '🌱';
                    position: absolute;
                    top: -8px;
                    left: -8px;
                    background: #4CAF50;
                    color: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
                }

                .message-content {
                    line-height: 1.6;
                    font-size: 15px;
                }

                .message-content strong {
                    display: block;
                    margin-bottom: 12px;
                    font-weight: 700;
                    font-size: 16px;
                    color: #1a202c;
                    border-bottom: 2px solid #4CAF50;
                    padding-bottom: 5px;
                }

                .ai-message .message-content strong {
                    color: #2d5a27;
                    border-bottom-color: #4CAF50;
                }

                .user-message .message-content strong {
                    color: white;
                    border-bottom-color: rgba(255, 255, 255, 0.3);
                }

                .message-content p {
                    margin: 12px 0;
                    padding: 8px 0;
                }

                .message-content p:first-child {
                    margin-top: 0;
                }

                .message-content p:last-child {
                    margin-bottom: 0;
                }

                .message-content ul, .message-content ol {
                    margin: 15px 0;
                    padding-left: 25px;
                }

                .message-content li {
                    margin: 8px 0;
                    padding: 4px 0;
                }

                .message-content code {
                    background: rgba(0, 0, 0, 0.1);
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-family: 'Monaco', 'Consolas', monospace;
                    font-size: 14px;
                }

                .user-message .message-content code {
                    background: rgba(255, 255, 255, 0.2);
                }

                .message-content blockquote {
                    border-left: 4px solid #4CAF50;
                    padding-left: 15px;
                    margin: 15px 0;
                    font-style: italic;
                    color: #4a5568;
                }

                .ai-message .message-content blockquote {
                    border-left-color: #2d5a27;
                }

                .timestamp {
                    font-size: 11px;
                    opacity: 0.7;
                    margin-top: 8px;
                    text-align: right;
                }

                .user-message .timestamp {
                    color: rgba(255, 255, 255, 0.8);
                }

                .ai-message .timestamp {
                    color: #718096;
                }

                /* Estilos para el indicador de escritura */
                .typing-indicator {
                    animation: pulse 1.5s infinite;
                }

                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.6; }
                }

                .typing-dots {
                    display: inline-block;
                }

                .typing-dots span {
                    display: inline-block;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: #4CAF50;
                    margin: 0 2px;
                    animation: typing 1.4s infinite;
                }

                .typing-dots span:nth-child(1) { animation-delay: 0s; }
                .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
                .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

                @keyframes typing {
                    0%, 60%, 100% {
                        transform: translateY(0);
                        opacity: 0.6;
                    }
                    30% {
                        transform: translateY(-10px);
                        opacity: 1;
                    }
                }

                /* Estilos para errores */
                .error-message {
                    background: linear-gradient(135deg, #fed7d7, #feb2b2);
                    border: 2px solid #e53e3e;
                    color: #c53030;
                }

                .error-message::before {
                    content: '⚠️';
                    position: absolute;
                    top: -8px;
                    left: -8px;
                    background: #e53e3e;
                    color: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                }

                /* Estilos responsivos */
                @media (max-width: 768px) {
                    .chat-container {
                        margin: 10px;
                        height: 80vh;
                        max-width: none;
                    }

                    .message {
                        max-width: 95%;
                        padding: 15px 20px;
                    }

                    .message-content {
                        font-size: 14px;
                    }
                }

                /* Estilos para el título del chat */
                .chat-header {
                    background: linear-gradient(135deg, #4CAF50, #2d5a27);
                    color: white;
                    padding: 15px 25px;
                    text-align: center;
                    border-bottom: 2px solid #1b4332;
                }

                .chat-header h1 {
                    margin: 0;
                    font-size: 1.5em;
                    font-weight: 600;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                }

                .chat-header .subtitle {
                    margin: 5px 0 0 0;
                    font-size: 0.9em;
                    opacity: 0.9;
                }
            </style>
        `;

        // Estilos para autenticación
        const authStyles = `
            <style>
                .auth-status {
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .user-info {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px 16px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 20px;
                    font-size: 14px;
                }

                .logout-btn, .login-btn, .auto-login-btn {
                    padding: 6px 12px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.3s ease;
                }

                .logout-btn {
                    background: #dc3545;
                    color: white;
                }

                .logout-btn:hover {
                    background: #c82333;
                }

                .login-btn {
                    background: #007bff;
                    color: white;
                }

                .login-btn:hover {
                    background: #0056b3;
                }

                .auto-login-btn {
                    background: #28a745;
                    color: white;
                }

                .auto-login-btn:hover {
                    background: #1e7e34;
                }

                /* Estilos para notas */
                .notas-resumen {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }

                .notas-resumen h4 {
                    margin: 0 0 10px 0;
                    color: #4CAF50;
                    font-size: 14px;
                }

                .nota-resumen {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 6px 0;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                    font-size: 12px;
                }

                .nota-resumen.importante {
                    background: rgba(255, 193, 7, 0.1);
                    border-left: 3px solid #ffc107;
                }

                .nota-fecha {
                    color: #888;
                    flex-shrink: 0;
                }

                .nota-tipo {
                    flex-shrink: 0;
                }

                .nota-contenido {
                    flex: 1;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                /* Panel lateral de notas */
                .notes-history {
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                }

                .notes-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }

                .notes-header h4 {
                    margin: 0;
                    color: #4CAF50;
                }

                .notes-count {
                    font-size: 12px;
                    color: #888;
                }

                .notes-list {
                    flex: 1;
                    overflow-y: auto;
                    margin-bottom: 20px;
                }

                .nota-item {
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 10px;
                    border-left: 3px solid #4CAF50;
                }

                .nota-item.importante {
                    border-left-color: #ffc107;
                    background: rgba(255, 193, 7, 0.1);
                }

                .nota-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                    font-size: 12px;
                }

                .nota-tipo {
                    font-weight: bold;
                }

                .nota-fecha {
                    color: #888;
                }

                .nota-importante {
                    color: #ffc107;
                }

                .nota-contenido {
                    margin-bottom: 5px;
                    line-height: 1.4;
                }

                .nota-fase {
                    font-size: 11px;
                    color: #4CAF50;
                    font-style: italic;
                }

                .no-notes {
                    text-align: center;
                    color: #888;
                    font-style: italic;
                    padding: 20px;
                }

                .add-note-section {
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    padding-top: 15px;
                }

                .add-note-section textarea {
                    width: 100%;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 6px;
                    padding: 10px;
                    color: white;
                    font-family: inherit;
                    resize: vertical;
                    margin-bottom: 10px;
                }

                .add-note-section textarea::placeholder {
                    color: #888;
                }

                .note-options {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    flex-wrap: wrap;
                }

                .note-type-select {
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 4px;
                    padding: 6px 8px;
                    color: white;
                    font-size: 12px;
                }

                .important-checkbox {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-size: 12px;
                    color: #ccc;
                }

                .important-checkbox input[type="checkbox"] {
                    margin: 0;
                }

                .save-notes-btn {
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background 0.3s;
                }

                .save-notes-btn:hover {
                    background: #45a049;
                }

                /* Estilos para información editable del cultivo */
                .cultivo-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid rgba(76, 175, 80, 0.3);
                }

                .cultivo-header h3 {
                    margin: 0;
                    color: #2d5a27;
                    font-size: 1.4em;
                    font-weight: 600;
                }

                .cultivo-actions {
                    display: flex;
                    gap: 8px;
                }

                .cultivo-info-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 25px;
                }

                .info-item {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }

                .info-item label {
                    font-weight: 600;
                    color: #4CAF50;
                    font-size: 0.9em;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .info-item span {
                    color: #333;
                    font-size: 1em;
                    padding: 8px 12px;
                    background: rgba(76, 175, 80, 0.05);
                    border-radius: 6px;
                    border: 1px solid transparent;
                    transition: all 0.3s ease;
                }

                .editable-field {
                    cursor: pointer;
                    transition: all 0.3s ease;
                }

                .editable-field:hover {
                    background: rgba(76, 175, 80, 0.1);
                    border-color: rgba(76, 175, 80, 0.3);
                }

                .editable-field.editing {
                    background: rgba(255, 255, 255, 0.9);
                    border-color: #4CAF50;
                    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
                    outline: none;
                }

                .edit-info-btn, .save-info-btn {
                    padding: 6px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    background: #4CAF50;
                    color: white;
                }

                .edit-info-btn:hover, .save-info-btn:hover {
                    background: #2d5a27;
                }

                /* Estilos para sección de notas del cultivo */
                .cultivo-notas-section {
                    margin-top: 25px;
                    padding-top: 20px;
                    border-top: 1px solid rgba(76, 175, 80, 0.2);
                }

                .cultivo-notas-section h4 {
                    margin: 0 0 15px 0;
                    color: #2d5a27;
                    font-size: 1.1em;
                }

                /* Estilos para zona de drop */
                .notas-drop-zone {
                    min-height: 100px;
                    border: 2px dashed rgba(76, 175, 80, 0.3);
                    border-radius: 8px;
                    padding: 15px;
                    background: rgba(76, 175, 80, 0.02);
                    transition: all 0.3s ease;
                    position: relative;
                }

                .notas-drop-zone.drag-over {
                    border-color: #4CAF50;
                    background: rgba(76, 175, 80, 0.1);
                    transform: scale(1.02);
                }

                .drop-hint {
                    color: #666;
                    font-style: italic;
                    text-align: center;
                    margin: 20px 0;
                    font-size: 0.9em;
                }

                .notas-drop-zone .drop-hint {
                    margin: 0;
                }

                /* Estilos para notas en el panel de información */
                .nota-in-info {
                    background: rgba(255, 255, 255, 0.9);
                    border: 1px solid rgba(76, 175, 80, 0.3);
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 10px;
                    position: relative;
                    transition: all 0.3s ease;
                }

                .nota-in-info:hover {
                    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
                }

                .nota-in-info.importante {
                    border-color: #ffc107;
                    background: rgba(255, 193, 7, 0.05);
                }

                .nota-in-info-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                    font-size: 0.85em;
                }

                .nota-in-info-content {
                    line-height: 1.5;
                    color: #333;
                }

                .remove-nota-btn {
                    background: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                }

                .remove-nota-btn:hover {
                    background: #c82333;
                    transform: scale(1.1);
                }

                /* Estilos para notas arrastrables */
                .draggable-nota {
                    cursor: grab;
                    transition: all 0.3s ease;
                    position: relative;
                }

                .draggable-nota:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }

                .draggable-nota.dragging {
                    opacity: 0.5;
                    transform: rotate(5deg);
                }

                .drag-handle {
                    cursor: grab;
                    color: #666;
                    font-size: 1.2em;
                    user-select: none;
                    margin-left: auto;
                }

                .drag-handle:hover {
                    color: #4CAF50;
                }

                .drag-hint {
                    font-size: 0.8em;
                    color: #666;
                    font-style: italic;
                    margin-top: 5px;
                }

                /* Mejoras visuales para el chat */
                .message-content {
                    line-height: 1.7;
                    font-size: 16px;
                    color: #2d3748;
                }

                .user-message .message-content {
                    color: white;
                }

                .message-content p {
                    margin: 16px 0;
                    text-align: justify;
                }

                .message-content p:first-child {
                    margin-top: 0;
                }

                .message-content p:last-child {
                    margin-bottom: 0;
                }

                .message-content ul, .message-content ol {
                    margin: 20px 0;
                    padding-left: 30px;
                }

                .message-content li {
                    margin: 10px 0;
                    padding: 6px 0;
                }

                .message-content strong {
                    font-weight: 700;
                    color: #1a202c;
                }

                .user-message .message-content strong {
                    color: white;
                }

                .message-content code {
                    background: rgba(0, 0, 0, 0.08);
                    padding: 3px 8px;
                    border-radius: 6px;
                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                    font-size: 14px;
                    border: 1px solid rgba(0, 0, 0, 0.1);
                }

                .user-message .message-content code {
                    background: rgba(255, 255, 255, 0.15);
                    border-color: rgba(255, 255, 255, 0.2);
                }

                .message-content blockquote {
                    border-left: 4px solid #4CAF50;
                    padding-left: 20px;
                    margin: 20px 0;
                    font-style: italic;
                    color: #4a5568;
                    background: rgba(76, 175, 80, 0.02);
                    padding: 15px 20px;
                    border-radius: 0 8px 8px 0;
                }

                .user-message .message-content blockquote {
                    border-left-color: rgba(255, 255, 255, 0.5);
                    background: rgba(255, 255, 255, 0.05);
                    color: rgba(255, 255, 255, 0.9);
                }

                /* Mejoras tipográficas */
                .message-content h1, .message-content h2, .message-content h3,
                .message-content h4, .message-content h5, .message-content h6 {
                    margin: 20px 0 12px 0;
                    font-weight: 600;
                    line-height: 1.3;
                }

                .message-content h1 {
                    font-size: 1.4em;
                    color: #1a202c;
                }

                .message-content h2 {
                    font-size: 1.3em;
                    color: #2d3748;
                }

                .message-content h3 {
                    font-size: 1.2em;
                    color: #4a5568;
                }

                .user-message .message-content h1,
                .user-message .message-content h2,
                .user-message .message-content h3 {
                    color: white;
                }

                /* Mejoras para listas */
                .message-content ul {
                    list-style-type: disc;
                }

                .message-content ol {
                    list-style-type: decimal;
                }

                .message-content li::marker {
                    color: #4CAF50;
                    font-weight: bold;
                }

                .user-message .message-content li::marker {
                    color: rgba(255, 255, 255, 0.8);
                }

                /* Mejoras para texto largo */
                .message-content {
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                    hyphens: auto;
                }

                /* Animaciones suaves */
                .message {
                    animation: fadeInUp 0.4s ease-out;
                }

                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                /* Responsive design improvements */
                @media (max-width: 768px) {
                    .cultivo-info-grid {
                        grid-template-columns: 1fr;
                        gap: 12px;
                    }

                    .cultivo-header {
                        flex-direction: column;
                        align-items: flex-start;
                        gap: 10px;
                    }

                    .cultivo-actions {
                        align-self: flex-end;
                    }

                    .nota-in-info-header {
                        flex-wrap: wrap;
                        gap: 8px;
                    }

                    .message-content {
                        font-size: 15px;
                    }
                }
            </style>
        `;

        // Agregar estilos del chat al head
        document.head.insertAdjacentHTML('beforeend', chatStyles);

        // Agregar estilos al head
        document.head.insertAdjacentHTML('beforeend', authStyles);

        // Inicializar Bruce AI cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar menú hamburguesa para móviles
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');

            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navToggle.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });

                // Cerrar menú cuando se hace click en un enlace
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    });
                });

                // Cerrar menú cuando se hace click fuera de él
                document.addEventListener('click', function(e) {
                    if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        navToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    }
                });
            }

            new BruceAI();
        });
    </script>
</body>

</html>