<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Categor√≠a Creation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Creaci√≥n de Categor√≠as</h1>

        <div class="test-section">
            <h2>1. Verificar Estado de Autenticaci√≥n</h2>
            <button onclick="checkAuthStatus()">Verificar Autenticaci√≥n</button>
            <div id="auth-status"></div>
        </div>

        <div class="test-section">
            <h2>2. Probar Creaci√≥n Directa de Categor√≠a</h2>
            <button onclick="testDirectCreation()">Crear Categor√≠a de Prueba</button>
            <div id="direct-test-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Probar con Datos del Formulario</h2>
            <form onsubmit="testFormSubmission(event)">
                <label>Nombre: <input type="text" id="test-name" value="Test Category" required></label><br>
                <label>Tipo:
                    <select id="test-type" required>
                        <option value="expense">Gasto</option>
                        <option value="income">Ingreso</option>
                    </select>
                </label><br>
                <label>Color: <input type="color" id="test-color" value="#FF5733" required></label><br>
                <label>Descripci√≥n: <textarea id="test-description"></textarea></label><br>
                <button type="submit">Enviar desde Formulario</button>
            </form>
            <div id="form-test-result"></div>
        </div>

        <div class="test-section">
            <h2>4. Logs de Depuraci√≥n</h2>
            <button onclick="clearLogs()">Limpiar Logs</button>
            <div id="debug-logs"></div>
        </div>
    </div>

    <script>
        const FINANCE_API_CONFIG = {
            baseUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000/api'
                : 'https://fedelife-finanzas.onrender.com/api'
        };

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }

        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };

            const authData = localStorage.getItem('auth_data');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    if (parsed.token) {
                        headers['Authorization'] = `Bearer ${parsed.token}`;
                    }
                } catch (error) {
                    log('Error parsing auth data: ' + error.message, 'error');
                }
            }

            return headers;
        }

        async function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            const authHeaders = getAuthHeaders();

            log('üîç Verificando estado de autenticaci√≥n...');
            log('Headers de autenticaci√≥n: ' + JSON.stringify({
                hasAuthorization: !!authHeaders['Authorization'],
                authTokenPreview: authHeaders['Authorization'] ? authHeaders['Authorization'].substring(0, 20) + '...' : 'none'
            }));

            try {
                const response = await fetch(`${FINANCE_API_CONFIG.baseUrl}/categories`, {
                    method: 'GET',
                    headers: authHeaders
                });

                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = '<div class="success">‚úÖ Autenticaci√≥n v√°lida - Usuario autenticado correctamente</div>';
                    log('‚úÖ Autenticaci√≥n exitosa');
                } else if (response.status === 401) {
                    statusDiv.innerHTML = '<div class="error">‚ùå Error de autenticaci√≥n - Token inv√°lido o expirado</div>';
                    log('‚ùå Error de autenticaci√≥n (401)');
                } else {
                    statusDiv.innerHTML = `<div class="error">‚ùå Error del servidor: ${response.status} ${response.statusText}</div>`;
                    log(`‚ùå Error del servidor: ${response.status}`);
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">‚ùå Error de conexi√≥n: ' + error.message + '</div>';
                log('‚ùå Error de conexi√≥n: ' + error.message, 'error');
            }
        }

        async function testDirectCreation() {
            const resultDiv = document.getElementById('direct-test-result');
            const authHeaders = getAuthHeaders();

            log('üß™ Probando creaci√≥n directa de categor√≠a...');

            const testData = {
                name: 'Test Direct ' + Date.now(),
                type: 'expense',
                color: '#00FF88',
                description: 'Categor√≠a creada desde test directo'
            };

            try {
                log('Enviando datos: ' + JSON.stringify(testData));
                log('URL: ' + `${FINANCE_API_CONFIG.baseUrl}/categories`);
                log('Headers: ' + JSON.stringify({
                    hasAuthorization: !!authHeaders['Authorization'],
                    contentType: authHeaders['Content-Type']
                }));

                const response = await fetch(`${FINANCE_API_CONFIG.baseUrl}/categories`, {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                log('Respuesta del servidor: ' + JSON.stringify({ status: response.status, result }));

                if (response.ok && result.success) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Categor√≠a creada exitosamente: ' + result.data.category.name + '</div>';
                    log('‚úÖ Test directo exitoso');
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå Error: ' + (result.message || `HTTP ${response.status}`) + '</div>';
                    log('‚ùå Test directo fallido: ' + result.message, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">‚ùå Error de conexi√≥n: ' + error.message + '</div>';
                log('‚ùå Error en test directo: ' + error.message, 'error');
            }
        }

        async function testFormSubmission(event) {
            event.preventDefault();
            const resultDiv = document.getElementById('form-test-result');
            const authHeaders = getAuthHeaders();

            const formData = {
                name: document.getElementById('test-name').value.trim(),
                type: document.getElementById('test-type').value,
                color: document.getElementById('test-color').value,
                description: document.getElementById('test-description').value.trim()
            };

            log('üìù Probando env√≠o desde formulario...');
            log('Datos del formulario: ' + JSON.stringify(formData));

            try {
                const response = await fetch(`${FINANCE_API_CONFIG.baseUrl}/categories`, {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                log('Respuesta del formulario: ' + JSON.stringify({ status: response.status, result }));

                if (response.ok && result.success) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Categor√≠a desde formulario creada: ' + result.data.category.name + '</div>';
                    log('‚úÖ Test desde formulario exitoso');
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå Error: ' + (result.message || `HTTP ${response.status}`) + '</div>';
                    log('‚ùå Test desde formulario fallido: ' + result.message, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">‚ùå Error de conexi√≥n: ' + error.message + '</div>';
                log('‚ùå Error en test desde formulario: ' + error.message, 'error');
            }
        }

        // Verificar autenticaci√≥n autom√°ticamente al cargar
        window.addEventListener('load', function() {
            log('üöÄ P√°gina de test cargada');
            log('Configuraci√≥n API: ' + JSON.stringify(FINANCE_API_CONFIG));
            setTimeout(() => {
                checkAuthStatus();
            }, 1000);
        });
    </script>
</body>
</html>
