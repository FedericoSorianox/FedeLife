<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Autenticaci√≥n Bruce - Fede Life</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f8f8; padding: 10px; overflow-x: auto; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç Debug Autenticaci√≥n - P√°gina de Bruce</h1>
    
    <div class="debug-section">
        <h3>1. Verificar localStorage</h3>
        <button onclick="checkLocalStorage()">Verificar localStorage</button>
        <div id="localStorage-result"></div>
    </div>

    <div class="debug-section">
        <h3>2. Probar m√©todo getAuthToken()</h3>
        <button onclick="testGetAuthToken()">Probar getAuthToken()</button>
        <div id="authToken-result"></div>
    </div>

    <div class="debug-section">
        <h3>3. Probar petici√≥n autenticada</h3>
        <button onclick="testAuthenticatedRequest()">Probar petici√≥n autenticada</button>
        <div id="request-result"></div>
    </div>

    <div class="debug-section">
        <h3>4. Soluci√≥n autom√°tica</h3>
        <button onclick="fixAuthIssue()">Solucionar problema de autenticaci√≥n</button>
        <div id="fix-result"></div>
    </div>

    <script>
        // Simular el m√©todo getAuthToken() de bruce.html
        function getAuthToken() {
            let token = localStorage.getItem('dev_auth_token');
            
            if (!token) {
                const authData = localStorage.getItem('auth_data');
                if (authData) {
                    try {
                        const parsed = JSON.parse(authData);
                        token = parsed.token;
                    } catch (error) {
                        console.error('Error parseando auth_data:', error);
                    }
                }
            }

            if (!token) {
                token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            }

            return token || '';
        }

        function checkLocalStorage() {
            const result = document.getElementById('localStorage-result');
            
            const devToken = localStorage.getItem('dev_auth_token');
            const authData = localStorage.getItem('auth_data');
            const authToken = localStorage.getItem('authToken');
            const sessionToken = sessionStorage.getItem('authToken');

            let html = '<div class="test-result">';
            html += '<h4>Estado del localStorage:</h4>';
            html += `<p>dev_auth_token: ${devToken ? '‚úÖ Presente (' + devToken.substring(0, 20) + '...)' : '‚ùå Ausente'}</p>`;
            html += `<p>auth_data: ${authData ? '‚úÖ Presente' : '‚ùå Ausente'}</p>`;
            html += `<p>authToken (localStorage): ${authToken ? '‚úÖ Presente' : '‚ùå Ausente'}</p>`;
            html += `<p>authToken (sessionStorage): ${sessionToken ? '‚úÖ Presente' : '‚ùå Ausente'}</p>`;
            
            if (devToken || authData || authToken || sessionToken) {
                html += '<p class="success">‚úÖ Hay al menos un token disponible</p>';
            } else {
                html += '<p class="error">‚ùå No hay tokens disponibles - necesitas iniciar sesi√≥n</p>';
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        function testGetAuthToken() {
            const result = document.getElementById('authToken-result');
            const token = getAuthToken();
            
            let html = '<div class="test-result">';
            html += '<h4>Resultado de getAuthToken():</h4>';
            html += `<p>Token encontrado: ${token ? '‚úÖ S√≠' : '‚ùå No'}</p>`;
            if (token) {
                html += `<p>Longitud: ${token.length} caracteres</p>`;
                html += `<p>Empieza con "eyJ": ${token.startsWith('eyJ') ? '‚úÖ Correcto (JWT)' : '‚ùå Incorrecto'}</p>`;
                html += `<p>Preview: ${token.substring(0, 50)}...</p>`;
                html += '<p class="success">‚úÖ El m√©todo getAuthToken() funciona correctamente</p>';
            } else {
                html += '<p class="error">‚ùå El m√©todo getAuthToken() no encontr√≥ ning√∫n token</p>';
            }
            html += '</div>';
            result.innerHTML = html;
        }

        async function testAuthenticatedRequest() {
            const result = document.getElementById('request-result');
            const token = getAuthToken();
            
            if (!token) {
                result.innerHTML = '<div class="test-result error">‚ùå No hay token disponible para probar</div>';
                return;
            }

            try {
                const response = await fetch('/api/cultivos/debug-auth', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                let html = '<div class="test-result">';
                html += '<h4>Resultado de petici√≥n autenticada:</h4>';
                html += `<p>Status: ${response.status}</p>`;
                
                if (response.ok) {
                    html += '<p class="success">‚úÖ Petici√≥n autenticada exitosa</p>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    html += '<p class="error">‚ùå Error en petici√≥n autenticada</p>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
                
                html += '</div>';
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = '<div class="test-result error">‚ùå Error de conexi√≥n: ' + error.message + '</div>';
            }
        }

        async function fixAuthIssue() {
            const result = document.getElementById('fix-result');
            
            // Intentar login autom√°tico
            try {
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identifier: 'dev@example.com',
                        password: 'dev123'
                    })
                });

                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    
                    // Guardar token en localStorage
                    localStorage.setItem('dev_auth_token', loginData.data.token);
                    
                    result.innerHTML = '<div class="test-result success">‚úÖ Login autom√°tico exitoso y token guardado</div>';
                    
                    // Re-verificar
                    setTimeout(() => {
                        checkLocalStorage();
                        testGetAuthToken();
                    }, 500);
                    
                } else {
                    const errorData = await loginResponse.json();
                    result.innerHTML = '<div class="test-result error">‚ùå Error en login autom√°tico: ' + errorData.message + '</div>';
                }
                
            } catch (error) {
                result.innerHTML = '<div class="test-result error">‚ùå Error de conexi√≥n en login: ' + error.message + '</div>';
            }
        }

        // Verificar estado inicial
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>
